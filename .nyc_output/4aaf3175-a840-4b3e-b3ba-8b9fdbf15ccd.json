{"C:\\dev\\quicksend-server\\src\\db\\models\\device.ts":{"path":"C:\\dev\\quicksend-server\\src\\db\\models\\device.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":19},"end":{"line":4,"column":63}},"3":{"start":{"line":5,"column":17},"end":{"line":5,"column":74}},"4":{"start":{"line":6,"column":20},"end":{"line":6,"column":72}},"5":{"start":{"line":7,"column":0},"end":{"line":7,"column":30}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\db\\models\\device.ts","sources":["C:\\dev\\quicksend-server\\src\\db\\models\\device.ts"],"names":[],"mappings":";;;AAAA,gEAAgC;AAChC,2EAAiD;AAEjD,MAAM,WAAW,GAAG,kBAAQ,CAAC,KAAK,CAAC,QAAQ,EAAE,gBAAY,CAAC,CAAC;AAE3D,kBAAe,WAAW,CAAC","sourcesContent":["import mongoose from \"mongoose\";\nimport DeviceSchema from \"src/db/schemas/device\";\n\nconst DeviceModel = mongoose.model(\"device\", DeviceSchema);\n\nexport default DeviceModel;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"8a5221042361f0f8ad18ee9fb5619b48a50ed6d0","contentHash":"dfb8ce245f616679b0587ce40ddcf16e9b6f40cbc119b911ea03057d5f636419"},"C:\\dev\\quicksend-server\\src\\db\\schemas\\device.ts":{"path":"C:\\dev\\quicksend-server\\src\\db\\schemas\\device.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":19},"end":{"line":4,"column":63}},"3":{"start":{"line":5,"column":15},"end":{"line":5,"column":69}},"4":{"start":{"line":6,"column":21},"end":{"line":17,"column":24}},"5":{"start":{"line":18,"column":0},"end":{"line":18,"column":31}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\db\\schemas\\device.ts","sources":["C:\\dev\\quicksend-server\\src\\db\\schemas\\device.ts"],"names":[],"mappings":";;;AAAA,gEAAgC;AAChC,sEAA2C;AAqB3C,MAAM,YAAY,GAAG,IAAI,kBAAQ,CAAC,MAAM,CACvC;IACC,IAAI,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE;IACtC,IAAI,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC,EAAE;IAClC,IAAI,EAAE;QACL,IAAI,EAAE,kBAAQ,CAAC,WAAW,CAAC,QAAQ;QACnC,QAAQ,EAAE,IAAI;QACd,GAAG,EAAE,cAAS;KACd;IACD,YAAY,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,IAAI,EAAE,EAAE;IACjD,kBAAkB,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE;IACpD,mBAAmB,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE;CACrD,EACD,EAAE,UAAU,EAAE,IAAI,EAAE,CACpB,CAAC;AAEF,kBAAe,YAAY,CAAC","sourcesContent":["import mongoose from \"mongoose\";\nimport UserModel from \"src/db/models/user\";\nimport { TimestampedDBObject } from \"./base\";\n\ninterface Device extends TimestampedDBObject {\n\tname: string;\n\t/**\n\t * ### Type meanings\n\t * | number | meaning                 |\n\t * |--------|-------------------------|\n\t * |      0 | Unknown device type     |\n\t * |      1 | Mobile device           |\n\t * |      2 | Desktop device          |\n\t * |     3+ | Unused                  |\n\t */\n\ttype: number;\n\tuser: mongoose.Types.ObjectId;\n\tlastActivity: Date;\n\tsignaturePublicKey: string;\n\tencryptionPublicKey: string;\n}\n\nconst DeviceSchema = new mongoose.Schema<Device>(\n\t{\n\t\tname: { type: String, required: true },\n\t\ttype: { type: Number, default: 0 },\n\t\tuser: {\n\t\t\ttype: mongoose.SchemaTypes.ObjectId,\n\t\t\trequired: true,\n\t\t\tref: UserModel\n\t\t},\n\t\tlastActivity: { type: Date, default: new Date() },\n\t\tsignaturePublicKey: { type: String, required: true },\n\t\tencryptionPublicKey: { type: String, required: true }\n\t},\n\t{ timestamps: true }\n);\n\nexport default DeviceSchema;\nexport type { Device };\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"af34116845a170492d1d97905e54009d028a890b","contentHash":"a5e3658c813ca0155c72485bc79894e45badeb79c489f5e8298c91c306dc0a4b"},"C:\\dev\\quicksend-server\\src\\db\\models\\user.ts":{"path":"C:\\dev\\quicksend-server\\src\\db\\models\\user.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":19},"end":{"line":4,"column":63}},"3":{"start":{"line":5,"column":15},"end":{"line":5,"column":70}},"4":{"start":{"line":6,"column":18},"end":{"line":6,"column":66}},"5":{"start":{"line":7,"column":0},"end":{"line":7,"column":28}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\db\\models\\user.ts","sources":["C:\\dev\\quicksend-server\\src\\db\\models\\user.ts"],"names":[],"mappings":";;;AAAA,gEAAgC;AAChC,uEAA6C;AAE7C,MAAM,SAAS,GAAG,kBAAQ,CAAC,KAAK,CAAC,MAAM,EAAE,cAAU,CAAC,CAAC;AAErD,kBAAe,SAAS,CAAC","sourcesContent":["import mongoose from \"mongoose\";\nimport UserSchema from \"src/db/schemas/user\";\n\nconst UserModel = mongoose.model(\"user\", UserSchema);\n\nexport default UserModel;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"855cc2ff28a79361595683345be59c697c1caf75","contentHash":"79d4b0400eb7318e77a405a5fd507d3be2e585c7a94359b5ab5722ebae8034a7"},"C:\\dev\\quicksend-server\\src\\db\\schemas\\user.ts":{"path":"C:\\dev\\quicksend-server\\src\\db\\schemas\\user.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":19},"end":{"line":4,"column":63}},"3":{"start":{"line":5,"column":19},"end":{"line":9,"column":24}},"4":{"start":{"line":10,"column":0},"end":{"line":10,"column":29}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\db\\schemas\\user.ts","sources":["C:\\dev\\quicksend-server\\src\\db\\schemas\\user.ts"],"names":[],"mappings":";;;AAAA,gEAAgC;AAShC,MAAM,UAAU,GAAG,IAAI,kBAAQ,CAAC,MAAM,CACrC;IACC,QAAQ,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE;IACrE,OAAO,EAAE,MAAM;IACf,YAAY,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE;CAC9C,EACD,EAAE,UAAU,EAAE,IAAI,EAAE,CACpB,CAAC;AAEF,kBAAe,UAAU,CAAC","sourcesContent":["import mongoose from \"mongoose\";\nimport { TimestampedDBObject } from \"./base\";\n\ninterface User extends TimestampedDBObject {\n\tusername: string;\n\tdisplay?: string;\n\tpasswordHash: string;\n}\n\nconst UserSchema = new mongoose.Schema<User>(\n\t{\n\t\tusername: { type: String, required: true, unique: true, index: true },\n\t\tdisplay: String,\n\t\tpasswordHash: { type: String, required: true }\n\t},\n\t{ timestamps: true }\n);\n\nexport default UserSchema;\nexport type { User };\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"7e084c36132bea6369911b56f024e7717daae35c","contentHash":"c471ab403a4a89877583621302db41bd232f6e5bfd68494e624d408537a361a6"},"C:\\dev\\quicksend-server\\src\\config.ts":{"path":"C:\\dev\\quicksend-server\\src\\config.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":59}},"3":{"start":{"line":5,"column":15},"end":{"line":5,"column":55}},"4":{"start":{"line":6,"column":0},"end":{"line":6,"column":26}},"5":{"start":{"line":7,"column":0},"end":{"line":10,"column":3}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\config.ts","sources":["C:\\dev\\quicksend-server\\src\\config.ts"],"names":[],"mappings":";;;AAAA,4DAA4B;AAC5B,wDAAwB;AAExB,gBAAM,CAAC,MAAM,EAAE,CAAC;AAChB,gBAAM,CAAC,MAAM,CAAC;IACb,IAAI,EAAE,cAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,YAAY,CAAC;IAC/C,QAAQ,EAAE,IAAI;CACd,CAAC,CAAC","sourcesContent":["import dotenv from \"dotenv\";\nimport path from \"path\";\n\ndotenv.config();\ndotenv.config({\n\tpath: path.resolve(process.cwd(), \".env.local\"),\n\toverride: true\n});\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"f86656e4a56ea457adf29bd7511a35f8953fa5b9","contentHash":"cd2a6d4622438b7989e4e7b3ba129867378747dab46793689915d2b24887ed58"},"C:\\dev\\quicksend-server\\src\\utils.ts":{"path":"C:\\dev\\quicksend-server\\src\\utils.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":0},"end":{"line":3,"column":171}},"2":{"start":{"line":5,"column":4},"end":{"line":5,"column":73}},"3":{"start":{"line":7,"column":0},"end":{"line":7,"column":48}},"4":{"start":{"line":9,"column":4},"end":{"line":10,"column":25}},"5":{"start":{"line":10,"column":8},"end":{"line":10,"column":25}},"6":{"start":{"line":11,"column":4},"end":{"line":11,"column":63}},"7":{"start":{"line":13,"column":0},"end":{"line":13,"column":36}},"8":{"start":{"line":15,"column":4},"end":{"line":16,"column":19}},"9":{"start":{"line":16,"column":8},"end":{"line":16,"column":19}},"10":{"start":{"line":17,"column":19},"end":{"line":17,"column":44}},"11":{"start":{"line":18,"column":4},"end":{"line":18,"column":37}},"12":{"start":{"line":20,"column":0},"end":{"line":20,"column":36}},"13":{"start":{"line":22,"column":4},"end":{"line":23,"column":19}},"14":{"start":{"line":23,"column":8},"end":{"line":23,"column":19}},"15":{"start":{"line":24,"column":19},"end":{"line":24,"column":45}},"16":{"start":{"line":25,"column":4},"end":{"line":25,"column":36}},"17":{"start":{"line":27,"column":0},"end":{"line":27,"column":36}},"18":{"start":{"line":29,"column":24},"end":{"line":29,"column":33}},"19":{"start":{"line":30,"column":4},"end":{"line":30,"column":50}},"20":{"start":{"line":30,"column":28},"end":{"line":30,"column":48}},"21":{"start":{"line":31,"column":4},"end":{"line":31,"column":52}},"22":{"start":{"line":31,"column":26},"end":{"line":31,"column":50}},"23":{"start":{"line":32,"column":4},"end":{"line":32,"column":33}},"24":{"start":{"line":34,"column":0},"end":{"line":34,"column":34}},"25":{"start":{"line":36,"column":18},"end":{"line":36,"column":35}},"26":{"start":{"line":37,"column":4},"end":{"line":38,"column":67}},"27":{"start":{"line":38,"column":8},"end":{"line":38,"column":67}},"28":{"start":{"line":39,"column":4},"end":{"line":39,"column":17}},"29":{"start":{"line":41,"column":0},"end":{"line":41,"column":38}},"30":{"start":{"line":43,"column":16},"end":{"line":43,"column":30}},"31":{"start":{"line":44,"column":19},"end":{"line":44,"column":37}},"32":{"start":{"line":45,"column":4},"end":{"line":47,"column":29}},"33":{"start":{"line":46,"column":8},"end":{"line":47,"column":29}},"34":{"start":{"line":47,"column":12},"end":{"line":47,"column":29}},"35":{"start":{"line":48,"column":4},"end":{"line":49,"column":25}},"36":{"start":{"line":49,"column":8},"end":{"line":49,"column":25}},"37":{"start":{"line":50,"column":4},"end":{"line":53,"column":6}},"38":{"start":{"line":55,"column":0},"end":{"line":55,"column":30}}},"fnMap":{"0":{"name":"collapseWhitespace","decl":{"start":{"line":4,"column":9},"end":{"line":4,"column":27}},"loc":{"start":{"line":4,"column":33},"end":{"line":6,"column":1}},"line":4},"1":{"name":"splitAtIndex","decl":{"start":{"line":8,"column":9},"end":{"line":8,"column":21}},"loc":{"start":{"line":8,"column":34},"end":{"line":12,"column":1}},"line":8},"2":{"name":"encodeBase64","decl":{"start":{"line":14,"column":9},"end":{"line":14,"column":21}},"loc":{"start":{"line":14,"column":27},"end":{"line":19,"column":1}},"line":14},"3":{"name":"decodeBase64","decl":{"start":{"line":21,"column":9},"end":{"line":21,"column":21}},"loc":{"start":{"line":21,"column":27},"end":{"line":26,"column":1}},"line":21},"4":{"name":"includesAll","decl":{"start":{"line":28,"column":9},"end":{"line":28,"column":20}},"loc":{"start":{"line":28,"column":37},"end":{"line":33,"column":1}},"line":28},"5":{"name":"(anonymous_5)","decl":{"start":{"line":30,"column":19},"end":{"line":30,"column":20}},"loc":{"start":{"line":30,"column":28},"end":{"line":30,"column":48}},"line":30},"6":{"name":"(anonymous_6)","decl":{"start":{"line":31,"column":16},"end":{"line":31,"column":17}},"loc":{"start":{"line":31,"column":26},"end":{"line":31,"column":50}},"line":31},"7":{"name":"requireEnvVar","decl":{"start":{"line":35,"column":9},"end":{"line":35,"column":22}},"loc":{"start":{"line":35,"column":29},"end":{"line":40,"column":1}},"line":35},"8":{"name":"arrayDiff","decl":{"start":{"line":42,"column":9},"end":{"line":42,"column":18}},"loc":{"start":{"line":42,"column":37},"end":{"line":54,"column":1}},"line":42}},"branchMap":{"0":{"loc":{"start":{"line":9,"column":4},"end":{"line":10,"column":25}},"type":"if","locations":[{"start":{"line":9,"column":4},"end":{"line":10,"column":25}},{"start":{"line":9,"column":4},"end":{"line":10,"column":25}}],"line":9},"1":{"loc":{"start":{"line":9,"column":8},"end":{"line":9,"column":39}},"type":"binary-expr","locations":[{"start":{"line":9,"column":8},"end":{"line":9,"column":17}},{"start":{"line":9,"column":21},"end":{"line":9,"column":39}}],"line":9},"2":{"loc":{"start":{"line":15,"column":4},"end":{"line":16,"column":19}},"type":"if","locations":[{"start":{"line":15,"column":4},"end":{"line":16,"column":19}},{"start":{"line":15,"column":4},"end":{"line":16,"column":19}}],"line":15},"3":{"loc":{"start":{"line":22,"column":4},"end":{"line":23,"column":19}},"type":"if","locations":[{"start":{"line":22,"column":4},"end":{"line":23,"column":19}},{"start":{"line":22,"column":4},"end":{"line":23,"column":19}}],"line":22},"4":{"loc":{"start":{"line":37,"column":4},"end":{"line":38,"column":67}},"type":"if","locations":[{"start":{"line":37,"column":4},"end":{"line":38,"column":67}},{"start":{"line":37,"column":4},"end":{"line":38,"column":67}}],"line":37},"5":{"loc":{"start":{"line":46,"column":8},"end":{"line":47,"column":29}},"type":"if","locations":[{"start":{"line":46,"column":8},"end":{"line":47,"column":29}},{"start":{"line":46,"column":8},"end":{"line":47,"column":29}}],"line":46}},"s":{"0":1,"1":1,"2":30,"3":1,"4":0,"5":0,"6":0,"7":1,"8":0,"9":0,"10":0,"11":0,"12":1,"13":7,"14":0,"15":7,"16":7,"17":1,"18":30,"19":30,"20":60,"21":30,"22":60,"23":30,"24":1,"25":7,"26":7,"27":0,"28":7,"29":1,"30":7,"31":7,"32":7,"33":8,"34":7,"35":7,"36":2,"37":7,"38":1},"f":{"0":30,"1":0,"2":0,"3":7,"4":30,"5":60,"6":60,"7":7,"8":7},"b":{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,7],"4":[0,7],"5":[7,1]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\utils.ts","sources":["C:\\dev\\quicksend-server\\src\\utils.ts"],"names":[],"mappings":";;;AAAA,SAAS,kBAAkB,CAAC,GAAW;IACtC,OAAO,GAAG,CAAC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;AACtE,CAAC;AAmDA,gDAAkB;AAjDnB,SAAS,YAAY,CAAC,GAAW,EAAE,KAAa;IAC/C,IAAI,KAAK,GAAG,CAAC,IAAI,KAAK,GAAG,GAAG,CAAC,MAAM;QAAE,OAAO,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC;IACtD,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,EAAE,KAAK,CAAC,EAAE,GAAG,CAAC,SAAS,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC;AAC5D,CAAC;AA+CA,oCAAY;AA7Cb,SAAS,YAAY,CAAC,GAAW;IAChC,IAAI,CAAC,GAAG;QAAE,OAAO,GAAG,CAAC;IACrB,MAAM,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;IACzC,OAAO,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;AAClC,CAAC;AA0CA,oCAAY;AAxCb,SAAS,YAAY,CAAC,GAAW;IAChC,IAAI,CAAC,GAAG;QAAE,OAAO,GAAG,CAAC;IACrB,MAAM,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC;IAC1C,OAAO,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;AACjC,CAAC;AAqCA,oCAAY;AAnCb,SAAS,WAAW,CAAI,GAAQ,EAAE,GAAG,MAAW;IAC/C,MAAM,WAAW,GAAG,IAAI,GAAG,EAAK,CAAC;IACjC,MAAM,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC;IAC9C,GAAG,CAAC,OAAO,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC;IAChD,OAAO,WAAW,CAAC,IAAI,IAAI,CAAC,CAAC;AAC9B,CAAC;AA+BA,kCAAW;AA7BZ,SAAS,aAAa,CAAC,IAAY;IAClC,MAAM,KAAK,GAAG,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;IAChC,IAAI,CAAC,KAAK;QAAE,MAAM,IAAI,KAAK,CAAC,iCAAiC,IAAI,IAAI,CAAC,CAAC;IACvE,OAAO,KAAK,CAAC;AACd,CAAC;AA0BA,sCAAa;AAnBd,SAAS,SAAS,CAAI,KAAU,EAAE,SAAc;IAC/C,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,KAAK,CAAC,CAAC;IAC3B,MAAM,MAAM,GAAG,IAAI,GAAG,CAAC,SAAS,CAAC,CAAC;IAElC,KAAK,MAAM,IAAI,IAAI,GAAG;QAAE,IAAI,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC;YAAE,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;IAClE,KAAK,MAAM,IAAI,IAAI,MAAM;QAAE,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;IAE5C,OAAO;QACN,OAAO,EAAE,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC;QAC3B,KAAK,EAAE,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC;KACtB,CAAC;AACH,CAAC;AASA,8BAAS","sourcesContent":["function collapseWhitespace(str: string) {\n\treturn str.replace(/ +/g, \" \").replace(/^ +/, \"\").replace(/ +$/, \"\");\n}\n\nfunction splitAtIndex(str: string, index: number): [string, string] {\n\tif (index < 0 || index > str.length) return [str, \"\"];\n\treturn [str.substring(0, index), str.substring(index + 1)];\n}\n\nfunction encodeBase64(str: string): string {\n\tif (!str) return str;\n\tconst buffer = Buffer.from(str, \"utf-8\");\n\treturn buffer.toString(\"base64\");\n}\n\nfunction decodeBase64(str: string): string {\n\tif (!str) return str;\n\tconst buffer = Buffer.from(str, \"base64\");\n\treturn buffer.toString(\"utf-8\");\n}\n\nfunction includesAll<T>(arr: T[], ...values: T[]): boolean {\n\tconst notIncluded = new Set<T>();\n\tvalues.forEach((val) => notIncluded.add(val));\n\tarr.forEach((item) => notIncluded.delete(item));\n\treturn notIncluded.size == 0;\n}\n\nfunction requireEnvVar(name: string): string {\n\tconst value = process.env[name];\n\tif (!value) throw new Error(`Missing environment variable '${name}'!`);\n\treturn value;\n}\n\ninterface ArrayDiff<T> {\n\tmissing: T[];\n\textra: T[];\n}\n\nfunction arrayDiff<T>(array: T[], reference: T[]): ArrayDiff<T> {\n\tconst set = new Set(array);\n\tconst refSet = new Set(reference);\n\n\tfor (const item of set) if (refSet.delete(item)) set.delete(item);\n\tfor (const item of refSet) set.delete(item);\n\n\treturn {\n\t\tmissing: Array.from(refSet),\n\t\textra: Array.from(set)\n\t};\n}\n\nexport {\n\tcollapseWhitespace,\n\tsplitAtIndex,\n\tencodeBase64,\n\tdecodeBase64,\n\tincludesAll,\n\trequireEnvVar,\n\tarrayDiff\n};\n\nexport type { ArrayDiff };\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"9da09ed31b21b242e39b9ad8db734ded020b0125","contentHash":"9604857165e159aadd7cbd1cd058170e6e32b46e3b02a05b5851d79453323fd7"},"C:\\dev\\quicksend-server\\src\\app.ts":{"path":"C:\\dev\\quicksend-server\\src\\app.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":14},"end":{"line":4,"column":53}},"3":{"start":{"line":5,"column":17},"end":{"line":5,"column":61}},"4":{"start":{"line":6,"column":17},"end":{"line":6,"column":61}},"5":{"start":{"line":7,"column":19},"end":{"line":7,"column":65}},"6":{"start":{"line":8,"column":19},"end":{"line":8,"column":65}},"7":{"start":{"line":9,"column":12},"end":{"line":9,"column":31}},"8":{"start":{"line":10,"column":0},"end":{"line":10,"column":35}},"9":{"start":{"line":11,"column":0},"end":{"line":11,"column":35}},"10":{"start":{"line":12,"column":0},"end":{"line":12,"column":33}},"11":{"start":{"line":13,"column":0},"end":{"line":13,"column":35}},"12":{"start":{"line":14,"column":0},"end":{"line":14,"column":43}},"13":{"start":{"line":15,"column":0},"end":{"line":15,"column":22}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":1,"13":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\app.ts","sources":["C:\\dev\\quicksend-server\\src\\app.ts"],"names":[],"mappings":";;;AAAA,sDAAsB;AACtB,8DAAoC;AACpC,8DAA8B;AAC9B,kEAAyC;AACzC,kEAAkC;AAElC,MAAM,GAAG,GAAG,IAAI,aAAG,EAAE,CAAC;AAEtB,GAAG,CAAC,GAAG,CAAC,IAAA,kBAAQ,GAAE,CAAC,CAAC;AACpB,GAAG,CAAC,GAAG,CAAC,IAAA,kBAAe,GAAE,CAAC,CAAC;AAC3B,GAAG,CAAC,GAAG,CAAC,IAAA,gBAAY,GAAE,CAAC,CAAC;AAExB,GAAG,CAAC,GAAG,CAAC,gBAAM,CAAC,MAAM,EAAE,CAAC,CAAC;AACzB,GAAG,CAAC,GAAG,CAAC,gBAAM,CAAC,cAAc,EAAE,CAAC,CAAC;AAEjC,kBAAe,GAAG,CAAC","sourcesContent":["import Koa from \"koa\";\nimport errorHandler from \"./errors\";\nimport router from \"./router\";\nimport responseHandler from \"./response\";\nimport compress from \"./compress\";\n\nconst app = new Koa();\n\napp.use(compress());\napp.use(responseHandler());\napp.use(errorHandler());\n\napp.use(router.routes());\napp.use(router.allowedMethods());\n\nexport default app;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"7b82438b23ad7af739135e48a2cd34366b2c31eb","contentHash":"2c10bfecec52e5862fa4f9ff306d2541d927f6159d99a8c0e7eef4075ff95c8a"},"C:\\dev\\quicksend-server\\src\\errors.ts":{"path":"C:\\dev\\quicksend-server\\src\\errors.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":59}},"3":{"start":{"line":5,"column":14},"end":{"line":5,"column":53}},"4":{"start":{"line":7,"column":4},"end":{"line":19,"column":7}},"5":{"start":{"line":7,"column":26},"end":{"line":19,"column":6}},"6":{"start":{"line":8,"column":8},"end":{"line":18,"column":9}},"7":{"start":{"line":9,"column":12},"end":{"line":9,"column":25}},"8":{"start":{"line":12,"column":12},"end":{"line":12,"column":106}},"9":{"start":{"line":13,"column":12},"end":{"line":13,"column":35}},"10":{"start":{"line":14,"column":12},"end":{"line":14,"column":83}},"11":{"start":{"line":15,"column":12},"end":{"line":15,"column":35}},"12":{"start":{"line":16,"column":12},"end":{"line":17,"column":56}},"13":{"start":{"line":17,"column":16},"end":{"line":17,"column":56}},"14":{"start":{"line":21,"column":0},"end":{"line":21,"column":31}}},"fnMap":{"0":{"name":"errorHandler","decl":{"start":{"line":6,"column":9},"end":{"line":6,"column":21}},"loc":{"start":{"line":6,"column":24},"end":{"line":20,"column":1}},"line":6},"1":{"name":"(anonymous_1)","decl":{"start":{"line":7,"column":11},"end":{"line":7,"column":12}},"loc":{"start":{"line":7,"column":26},"end":{"line":19,"column":6}},"line":7},"2":{"name":"(anonymous_2)","decl":{"start":{"line":7,"column":66},"end":{"line":7,"column":67}},"loc":{"start":{"line":7,"column":79},"end":{"line":19,"column":5}},"line":7}},"branchMap":{"0":{"loc":{"start":{"line":14,"column":25},"end":{"line":14,"column":82}},"type":"cond-expr","locations":[{"start":{"line":14,"column":66},"end":{"line":14,"column":76}},{"start":{"line":14,"column":79},"end":{"line":14,"column":82}}],"line":14},"1":{"loc":{"start":{"line":16,"column":12},"end":{"line":17,"column":56}},"type":"if","locations":[{"start":{"line":16,"column":12},"end":{"line":17,"column":56}},{"start":{"line":16,"column":12},"end":{"line":17,"column":56}}],"line":16}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":46,"6":46,"7":46,"8":26,"9":26,"10":26,"11":26,"12":26,"13":0,"14":1},"f":{"0":1,"1":46,"2":46},"b":{"0":[26,0],"1":[0,26]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\errors.ts","sources":["C:\\dev\\quicksend-server\\src\\errors.ts"],"names":[],"mappings":";;;AAAA,4DAA4B;AAC5B,sDAAsB;AAEtB,SAAS,YAAY;IACpB,OAAO,CAAO,GAAG,EAAE,IAAI,EAAE,EAAE;QAC1B,IAAI;YACH,MAAM,IAAI,EAAE,CAAC;SACb;QAAC,OAAO,GAAG,EAAE;YACb,IAAA,gBAAM,EACL,GAAG,YAAY,KAAK,EACpB,oCAAoC,OAAO,GAAG,EAAE,CAChD,CAAC;YACF,GAAG,CAAC,KAAK,CAAC,KAAK,GAAG,IAAI,CAAC;YACvB,GAAG,CAAC,MAAM,GAAG,GAAG,YAAY,aAAG,CAAC,SAAS,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC,GAAG,CAAC;YAC7D,GAAG,CAAC,IAAI,GAAG,GAAG,CAAC,OAAO,CAAC;YACvB,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG;gBAAE,OAAO,CAAC,KAAK,CAAC,UAAU,GAAG,GAAG,CAAC,OAAO,CAAC,CAAC;SAC/D;IACF,CAAC,CAAA,CAAC;AACH,CAAC;AAED,kBAAe,YAAY,CAAC","sourcesContent":["import assert from \"assert\";\nimport Koa from \"koa\";\n\nfunction errorHandler(): Koa.Middleware {\n\treturn async (ctx, next) => {\n\t\ttry {\n\t\t\tawait next();\n\t\t} catch (err) {\n\t\t\tassert(\n\t\t\t\terr instanceof Error,\n\t\t\t\t`Unexpected thrown object of type ${typeof err}`\n\t\t\t);\n\t\t\tctx.state.error = true;\n\t\t\tctx.status = err instanceof Koa.HttpError ? err.status : 500;\n\t\t\tctx.body = err.message;\n\t\t\tif (ctx.status == 500) console.error(\"[ERROR] \" + err.message);\n\t\t}\n\t};\n}\n\nexport default errorHandler;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"014c4d275067ec2fc7f7e08ab3693c706e6c9fcf","contentHash":"e9e3f6e0c413a31f1a592f5a55449fab6bbf4a15f033e1c53edf7415e0855a2e"},"C:\\dev\\quicksend-server\\src\\router.ts":{"path":"C:\\dev\\quicksend-server\\src\\router.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":64}},"3":{"start":{"line":5,"column":15},"end":{"line":5,"column":61}},"4":{"start":{"line":6,"column":18},"end":{"line":6,"column":67}},"5":{"start":{"line":7,"column":25},"end":{"line":7,"column":75}},"6":{"start":{"line":8,"column":19},"end":{"line":8,"column":69}},"7":{"start":{"line":9,"column":15},"end":{"line":9,"column":37}},"8":{"start":{"line":10,"column":0},"end":{"line":10,"column":44}},"9":{"start":{"line":11,"column":0},"end":{"line":11,"column":69}},"10":{"start":{"line":12,"column":0},"end":{"line":12,"column":75}},"11":{"start":{"line":13,"column":0},"end":{"line":13,"column":77}},"12":{"start":{"line":14,"column":0},"end":{"line":14,"column":25}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\router.ts","sources":["C:\\dev\\quicksend-server\\src\\router.ts"],"names":[],"mappings":";;;AAAA,iEAAiC;AACjC,8DAA8B;AAC9B,oEAAoC;AACpC,4EAAwC;AACxC,sEAAsC;AAEtC,MAAM,MAAM,GAAG,IAAI,gBAAM,EAAE,CAAC;AAC5B,MAAM,CAAC,GAAG,CAAC,IAAA,wBAAU,GAAE,CAAC,CAAC;AACzB,MAAM,CAAC,GAAG,CAAC,cAAI,CAAC,MAAM,EAAE,EAAE,cAAI,CAAC,cAAc,EAAE,CAAC,CAAC;AACjD,MAAM,CAAC,GAAG,CAAC,iBAAO,CAAC,MAAM,EAAE,EAAE,iBAAO,CAAC,cAAc,EAAE,CAAC,CAAC;AACvD,MAAM,CAAC,GAAG,CAAC,kBAAQ,CAAC,MAAM,EAAE,EAAE,kBAAQ,CAAC,cAAc,EAAE,CAAC,CAAC;AAEzD,kBAAe,MAAM,CAAC","sourcesContent":["import Router from \"@koa/router\";\nimport user from \"./api/user\";\nimport devices from \"./api/devices\";\nimport bodyParser from \"koa-bodyparser\";\nimport messages from \"./api/messages\";\n\nconst router = new Router();\nrouter.use(bodyParser());\nrouter.use(user.routes(), user.allowedMethods());\nrouter.use(devices.routes(), devices.allowedMethods());\nrouter.use(messages.routes(), messages.allowedMethods());\n\nexport default router;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"af553680fa96050c0809353dc58f80a673a3691d","contentHash":"3504d69f4f9f62a64bb59129a678a42297b9d6ea0766edb245fd8b6256ecc0d7"},"C:\\dev\\quicksend-server\\src\\api\\user.ts":{"path":"C:\\dev\\quicksend-server\\src\\api\\user.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":64}},"3":{"start":{"line":5,"column":14},"end":{"line":5,"column":53}},"4":{"start":{"line":6,"column":19},"end":{"line":6,"column":63}},"5":{"start":{"line":7,"column":25},"end":{"line":7,"column":79}},"6":{"start":{"line":8,"column":18},"end":{"line":8,"column":70}},"7":{"start":{"line":9,"column":23},"end":{"line":9,"column":83}},"8":{"start":{"line":10,"column":13},"end":{"line":10,"column":54}},"9":{"start":{"line":11,"column":29},"end":{"line":11,"column":31}},"10":{"start":{"line":12,"column":25},"end":{"line":20,"column":2}},"11":{"start":{"line":21,"column":0},"end":{"line":33,"column":4}},"12":{"start":{"line":21,"column":85},"end":{"line":33,"column":2}},"13":{"start":{"line":22,"column":17},"end":{"line":22,"column":33}},"14":{"start":{"line":23,"column":4},"end":{"line":24,"column":53}},"15":{"start":{"line":24,"column":8},"end":{"line":24,"column":53}},"16":{"start":{"line":25,"column":20},"end":{"line":29,"column":6}},"17":{"start":{"line":30,"column":4},"end":{"line":30,"column":21}},"18":{"start":{"line":31,"column":4},"end":{"line":31,"column":48}},"19":{"start":{"line":32,"column":4},"end":{"line":32,"column":18}},"20":{"start":{"line":34,"column":0},"end":{"line":42,"column":4}},"21":{"start":{"line":34,"column":70},"end":{"line":42,"column":2}},"22":{"start":{"line":35,"column":21},"end":{"line":35,"column":35}},"23":{"start":{"line":36,"column":4},"end":{"line":40,"column":6}},"24":{"start":{"line":41,"column":4},"end":{"line":41,"column":18}},"25":{"start":{"line":43,"column":0},"end":{"line":43,"column":23}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":21,"column":70},"end":{"line":21,"column":71}},"loc":{"start":{"line":21,"column":85},"end":{"line":33,"column":2}},"line":21},"1":{"name":"(anonymous_1)","decl":{"start":{"line":21,"column":127},"end":{"line":21,"column":128}},"loc":{"start":{"line":21,"column":140},"end":{"line":33,"column":1}},"line":21},"2":{"name":"(anonymous_2)","decl":{"start":{"line":34,"column":55},"end":{"line":34,"column":56}},"loc":{"start":{"line":34,"column":70},"end":{"line":42,"column":2}},"line":34},"3":{"name":"(anonymous_3)","decl":{"start":{"line":34,"column":112},"end":{"line":34,"column":113}},"loc":{"start":{"line":34,"column":125},"end":{"line":42,"column":1}},"line":34}},"branchMap":{"0":{"loc":{"start":{"line":23,"column":4},"end":{"line":24,"column":53}},"type":"if","locations":[{"start":{"line":23,"column":4},"end":{"line":24,"column":53}},{"start":{"line":23,"column":4},"end":{"line":24,"column":53}}],"line":23}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":3,"13":3,"14":3,"15":1,"16":2,"17":2,"18":2,"19":2,"20":1,"21":1,"22":1,"23":1,"24":1,"25":1},"f":{"0":3,"1":3,"2":1,"3":1},"b":{"0":[1,2]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\api\\user.ts","sources":["C:\\dev\\quicksend-server\\src\\api\\user.ts"],"names":[],"mappings":";;;AAAA,iEAAiC;AACjC,sDAAsB;AACtB,gEAA8B;AAC9B,gFAA+C;AAC/C,uEAAyD;AACzD,oFAAmD;AAEnD,MAAM,IAAI,GAAG,IAAI,gBAAM,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC,CAAC;AAE7C,MAAM,oBAAoB,GAAG,EAAE,CAAC;AAQhC,MAAM,gBAAgB,GAAG,aAAG,CAAC,MAAM,CAAoB;IACtD,QAAQ,EAAE,aAAG,CAAC,MAAM,EAAE;SACpB,OAAO,CAAC,gBAAgB,CAAC;SACzB,GAAG,CAAC,CAAC,CAAC;SACN,GAAG,CAAC,EAAE,CAAC;SACP,QAAQ,EAAE;IACZ,OAAO,EAAE,aAAG,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC;IACpC,QAAQ,EAAE,aAAG,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,QAAQ,EAAE;CAChD,CAAC,CAAC;AAEH,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,IAAA,wBAAa,EAAC,gBAAgB,CAAC,EAAE,CAAO,GAAG,EAAE,IAAI,EAAE,EAAE;IACzE,MAAM,IAAI,GAAG,GAAG,CAAC,OAAO,CAAC,IAAyB,CAAC;IAEnD,IAAI,MAAM,sBAAW,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC;QAClD,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IAE9C,MAAM,OAAO,GAAG,MAAM,sBAAW,CAAC,MAAM,CAAC;QACxC,QAAQ,EAAE,IAAI,CAAC,QAAQ;QACvB,OAAO,EAAE,IAAI,CAAC,OAAO;QACrB,YAAY,EAAE,kBAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,QAAQ,EAAE,oBAAoB,CAAC;KAClE,CAAC,CAAC;IAEH,GAAG,CAAC,MAAM,GAAG,GAAG,CAAC;IACjB,GAAG,CAAC,IAAI,GAAG,EAAE,EAAE,EAAE,OAAO,CAAC,EAAE,CAAC,WAAW,EAAE,EAAE,CAAC;IAC5C,OAAO,IAAI,EAAE,CAAC;AACf,CAAC,CAAA,CAAC,CAAC;AAEH,IAAI,CAAC,GAAG,CAAC,OAAO,EAAE,IAAA,iBAAW,EAAC,WAAW,CAAC,EAAE,CAAO,GAAG,EAAE,IAAI,EAAE,EAAE;IAC/D,MAAM,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,IAAgB,CAAC;IAE5C,GAAG,CAAC,IAAI,GAAG;QACV,EAAE,EAAE,QAAQ,CAAC,EAAE,CAAC,WAAW,EAAE;QAC7B,QAAQ,EAAE,QAAQ,CAAC,QAAQ;QAC3B,OAAO,EAAE,QAAQ,CAAC,OAAO;KACzB,CAAC;IAEF,OAAO,IAAI,EAAE,CAAC;AACf,CAAC,CAAA,CAAC,CAAC;AAEH,kBAAe,IAAI,CAAC","sourcesContent":["import Router from \"@koa/router\";\nimport Joi from \"joi\";\nimport bcrypt from \"bcryptjs\";\nimport bodyValidator from \"src/body_validator\";\nimport authHandler, { UserData } from \"src/auth/handler\";\nimport userManager from \"src/control/user_manager\";\n\nconst user = new Router({ prefix: \"/user\" });\n\nconst PASSWORD_SALT_LENGTH = 10;\n\ninterface CreateUserRequest {\n\tusername: string;\n\tdisplay?: string;\n\tpassword: string;\n}\n\nconst createUserSchema = Joi.object<CreateUserRequest>({\n\tusername: Joi.string()\n\t\t.pattern(/^[a-z0-9_-]+$/i)\n\t\t.min(3)\n\t\t.max(30)\n\t\t.required(),\n\tdisplay: Joi.string().min(3).max(30),\n\tpassword: Joi.string().min(5).max(50).required()\n});\n\nuser.post(\"/create\", bodyValidator(createUserSchema), async (ctx, next) => {\n\tconst body = ctx.request.body as CreateUserRequest;\n\n\tif (await userManager.usernameExists(body.username))\n\t\treturn ctx.throw(400, \"User already exists\");\n\n\tconst userCtr = await userManager.create({\n\t\tusername: body.username,\n\t\tdisplay: body.display,\n\t\tpasswordHash: bcrypt.hashSync(body.password, PASSWORD_SALT_LENGTH)\n\t});\n\n\tctx.status = 201;\n\tctx.body = { id: userCtr.id.toHexString() };\n\treturn next();\n});\n\nuser.get(\"/info\", authHandler(\"Signature\"), async (ctx, next) => {\n\tconst userData = ctx.state.user as UserData;\n\n\tctx.body = {\n\t\tid: userData.id.toHexString(),\n\t\tusername: userData.username,\n\t\tdisplay: userData.display\n\t};\n\n\treturn next();\n});\n\nexport default user;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"5882295162cf679ca312c034a95d5e09fa272985","contentHash":"8e3e8b4b53680e874e795415f23ac5e3ad83371d923ff9c5a3163c266de0b33e"},"C:\\dev\\quicksend-server\\src\\body_validator.ts":{"path":"C:\\dev\\quicksend-server\\src\\body_validator.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":4,"column":4},"end":{"line":11,"column":6}},"2":{"start":{"line":5,"column":39},"end":{"line":5,"column":72}},"3":{"start":{"line":6,"column":8},"end":{"line":7,"column":49}},"4":{"start":{"line":7,"column":12},"end":{"line":7,"column":49}},"5":{"start":{"line":8,"column":8},"end":{"line":9,"column":67}},"6":{"start":{"line":9,"column":12},"end":{"line":9,"column":67}},"7":{"start":{"line":10,"column":8},"end":{"line":10,"column":22}},"8":{"start":{"line":13,"column":0},"end":{"line":13,"column":32}}},"fnMap":{"0":{"name":"bodyValidator","decl":{"start":{"line":3,"column":9},"end":{"line":3,"column":22}},"loc":{"start":{"line":3,"column":31},"end":{"line":12,"column":1}},"line":3},"1":{"name":"(anonymous_1)","decl":{"start":{"line":4,"column":11},"end":{"line":4,"column":12}},"loc":{"start":{"line":4,"column":26},"end":{"line":11,"column":5}},"line":4}},"branchMap":{"0":{"loc":{"start":{"line":6,"column":8},"end":{"line":7,"column":49}},"type":"if","locations":[{"start":{"line":6,"column":8},"end":{"line":7,"column":49}},{"start":{"line":6,"column":8},"end":{"line":7,"column":49}}],"line":6},"1":{"loc":{"start":{"line":8,"column":8},"end":{"line":9,"column":67}},"type":"if","locations":[{"start":{"line":8,"column":8},"end":{"line":9,"column":67}},{"start":{"line":8,"column":8},"end":{"line":9,"column":67}}],"line":8}},"s":{"0":1,"1":4,"2":30,"3":30,"4":9,"5":21,"6":0,"7":21,"8":1},"f":{"0":4,"1":30},"b":{"0":[9,21],"1":[0,21]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\body_validator.ts","sources":["C:\\dev\\quicksend-server\\src\\body_validator.ts"],"names":[],"mappings":";;AAGA,SAAS,aAAa,CAAC,MAAkB;IACxC,OAAO,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE;QACpB,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG,MAAM,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACjE,IAAI,KAAK;YAAE,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,EAAE,KAAK,CAAC,OAAO,CAAC,CAAC;QAChD,IAAI,CAAC,IAAI;YAAE,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,EAAE,+BAA+B,CAAC,CAAC;QAClE,OAAO,IAAI,EAAE,CAAC;IACf,CAAC,CAAC;AACH,CAAC;AAED,kBAAe,aAAa,CAAC","sourcesContent":["import Koa from \"koa\";\nimport Joi from \"joi\";\n\nfunction bodyValidator(schema: Joi.Schema): Koa.Middleware {\n\treturn (ctx, next) => {\n\t\tconst { error, value: body } = schema.validate(ctx.request.body);\n\t\tif (error) return ctx.throw(400, error.message);\n\t\tif (!body) return ctx.throw(400, \"Unexpected empty request body\");\n\t\treturn next();\n\t};\n}\n\nexport default bodyValidator;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"99f04189f6a6799e74aa275ce54d033fb944c474","contentHash":"2611d21c81970b31ad207974aea26877272b7536ecb22c29874723a9e5bb4029"},"C:\\dev\\quicksend-server\\src\\auth\\handler.ts":{"path":"C:\\dev\\quicksend-server\\src\\auth\\handler.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":59}},"3":{"start":{"line":5,"column":19},"end":{"line":5,"column":63}},"4":{"start":{"line":6,"column":16},"end":{"line":6,"column":59}},"5":{"start":{"line":7,"column":16},"end":{"line":7,"column":36}},"6":{"start":{"line":8,"column":23},"end":{"line":8,"column":83}},"7":{"start":{"line":9,"column":25},"end":{"line":9,"column":87}},"8":{"start":{"line":10,"column":16},"end":{"line":10,"column":44}},"9":{"start":{"line":12,"column":4},"end":{"line":24,"column":7}},"10":{"start":{"line":13,"column":39},"end":{"line":13,"column":42}},"11":{"start":{"line":14,"column":21},"end":{"line":14,"column":72}},"12":{"start":{"line":15,"column":8},"end":{"line":16,"column":56}},"13":{"start":{"line":16,"column":12},"end":{"line":16,"column":56}},"14":{"start":{"line":17,"column":8},"end":{"line":18,"column":57}},"15":{"start":{"line":18,"column":12},"end":{"line":18,"column":57}},"16":{"start":{"line":19,"column":8},"end":{"line":23,"column":10}},"17":{"start":{"line":27,"column":23},"end":{"line":27,"column":25}},"18":{"start":{"line":28,"column":4},"end":{"line":37,"column":5}},"19":{"start":{"line":30,"column":8},"end":{"line":33,"column":36}},"20":{"start":{"line":31,"column":12},"end":{"line":31,"column":61}},"21":{"start":{"line":33,"column":12},"end":{"line":33,"column":36}},"22":{"start":{"line":34,"column":8},"end":{"line":35,"column":93}},"23":{"start":{"line":35,"column":12},"end":{"line":35,"column":93}},"24":{"start":{"line":36,"column":8},"end":{"line":36,"column":48}},"25":{"start":{"line":38,"column":4},"end":{"line":38,"column":24}},"26":{"start":{"line":40,"column":33},"end":{"line":40,"column":61}},"27":{"start":{"line":43,"column":4},"end":{"line":65,"column":7}},"28":{"start":{"line":44,"column":24},"end":{"line":44,"column":84}},"29":{"start":{"line":45,"column":8},"end":{"line":46,"column":74}},"30":{"start":{"line":46,"column":12},"end":{"line":46,"column":74}},"31":{"start":{"line":47,"column":8},"end":{"line":48,"column":48}},"32":{"start":{"line":48,"column":12},"end":{"line":48,"column":48}},"33":{"start":{"line":49,"column":23},"end":{"line":49,"column":98}},"34":{"start":{"line":50,"column":8},"end":{"line":51,"column":57}},"35":{"start":{"line":51,"column":12},"end":{"line":51,"column":57}},"36":{"start":{"line":52,"column":29},"end":{"line":52,"column":64}},"37":{"start":{"line":53,"column":23},"end":{"line":53,"column":160}},"38":{"start":{"line":54,"column":8},"end":{"line":55,"column":57}},"39":{"start":{"line":55,"column":12},"end":{"line":55,"column":57}},"40":{"start":{"line":56,"column":21},"end":{"line":56,"column":76}},"41":{"start":{"line":57,"column":8},"end":{"line":58,"column":66}},"42":{"start":{"line":58,"column":12},"end":{"line":58,"column":66}},"43":{"start":{"line":59,"column":8},"end":{"line":63,"column":10}},"44":{"start":{"line":64,"column":8},"end":{"line":64,"column":37}},"45":{"start":{"line":67,"column":30},"end":{"line":70,"column":1}},"46":{"start":{"line":72,"column":4},"end":{"line":90,"column":7}},"47":{"start":{"line":72,"column":26},"end":{"line":90,"column":6}},"48":{"start":{"line":73,"column":8},"end":{"line":76,"column":9}},"49":{"start":{"line":74,"column":12},"end":{"line":74,"column":73}},"50":{"start":{"line":75,"column":12},"end":{"line":75,"column":50}},"51":{"start":{"line":77,"column":24},"end":{"line":77,"column":70}},"52":{"start":{"line":78,"column":8},"end":{"line":79,"column":68}},"53":{"start":{"line":79,"column":12},"end":{"line":79,"column":68}},"54":{"start":{"line":80,"column":8},"end":{"line":81,"column":89}},"55":{"start":{"line":81,"column":12},"end":{"line":81,"column":89}},"56":{"start":{"line":82,"column":8},"end":{"line":88,"column":9}},"57":{"start":{"line":84,"column":16},"end":{"line":84,"column":54}},"58":{"start":{"line":85,"column":16},"end":{"line":85,"column":22}},"59":{"start":{"line":87,"column":16},"end":{"line":87,"column":58}},"60":{"start":{"line":89,"column":8},"end":{"line":89,"column":22}},"61":{"start":{"line":92,"column":0},"end":{"line":92,"column":30}}},"fnMap":{"0":{"name":"authenticateBasic","decl":{"start":{"line":11,"column":9},"end":{"line":11,"column":26}},"loc":{"start":{"line":11,"column":37},"end":{"line":25,"column":1}},"line":11},"1":{"name":"(anonymous_1)","decl":{"start":{"line":12,"column":51},"end":{"line":12,"column":52}},"loc":{"start":{"line":12,"column":64},"end":{"line":24,"column":5}},"line":12},"2":{"name":"createSignatureString","decl":{"start":{"line":26,"column":9},"end":{"line":26,"column":30}},"loc":{"start":{"line":26,"column":45},"end":{"line":39,"column":1}},"line":26},"3":{"name":"authenticateSignature","decl":{"start":{"line":41,"column":9},"end":{"line":41,"column":30}},"loc":{"start":{"line":41,"column":41},"end":{"line":66,"column":1}},"line":41},"4":{"name":"(anonymous_4)","decl":{"start":{"line":43,"column":51},"end":{"line":43,"column":52}},"loc":{"start":{"line":43,"column":64},"end":{"line":65,"column":5}},"line":43},"5":{"name":"authHandler","decl":{"start":{"line":71,"column":9},"end":{"line":71,"column":20}},"loc":{"start":{"line":71,"column":45},"end":{"line":91,"column":1}},"line":71},"6":{"name":"(anonymous_6)","decl":{"start":{"line":72,"column":11},"end":{"line":72,"column":12}},"loc":{"start":{"line":72,"column":26},"end":{"line":90,"column":6}},"line":72},"7":{"name":"(anonymous_7)","decl":{"start":{"line":72,"column":66},"end":{"line":72,"column":67}},"loc":{"start":{"line":72,"column":79},"end":{"line":90,"column":5}},"line":72}},"branchMap":{"0":{"loc":{"start":{"line":15,"column":8},"end":{"line":16,"column":56}},"type":"if","locations":[{"start":{"line":15,"column":8},"end":{"line":16,"column":56}},{"start":{"line":15,"column":8},"end":{"line":16,"column":56}}],"line":15},"1":{"loc":{"start":{"line":17,"column":8},"end":{"line":18,"column":57}},"type":"if","locations":[{"start":{"line":17,"column":8},"end":{"line":18,"column":57}},{"start":{"line":17,"column":8},"end":{"line":18,"column":57}}],"line":17},"2":{"loc":{"start":{"line":30,"column":8},"end":{"line":33,"column":36}},"type":"if","locations":[{"start":{"line":30,"column":8},"end":{"line":33,"column":36}},{"start":{"line":30,"column":8},"end":{"line":33,"column":36}}],"line":30},"3":{"loc":{"start":{"line":34,"column":8},"end":{"line":35,"column":93}},"type":"if","locations":[{"start":{"line":34,"column":8},"end":{"line":35,"column":93}},{"start":{"line":34,"column":8},"end":{"line":35,"column":93}}],"line":34},"4":{"loc":{"start":{"line":44,"column":24},"end":{"line":44,"column":84}},"type":"cond-expr","locations":[{"start":{"line":44,"column":71},"end":{"line":44,"column":73}},{"start":{"line":44,"column":76},"end":{"line":44,"column":84}}],"line":44},"5":{"loc":{"start":{"line":44,"column":24},"end":{"line":44,"column":68}},"type":"binary-expr","locations":[{"start":{"line":44,"column":24},"end":{"line":44,"column":51}},{"start":{"line":44,"column":55},"end":{"line":44,"column":68}}],"line":44},"6":{"loc":{"start":{"line":45,"column":8},"end":{"line":46,"column":74}},"type":"if","locations":[{"start":{"line":45,"column":8},"end":{"line":46,"column":74}},{"start":{"line":45,"column":8},"end":{"line":46,"column":74}}],"line":45},"7":{"loc":{"start":{"line":47,"column":8},"end":{"line":48,"column":48}},"type":"if","locations":[{"start":{"line":47,"column":8},"end":{"line":48,"column":48}},{"start":{"line":47,"column":8},"end":{"line":48,"column":48}}],"line":47},"8":{"loc":{"start":{"line":50,"column":8},"end":{"line":51,"column":57}},"type":"if","locations":[{"start":{"line":50,"column":8},"end":{"line":51,"column":57}},{"start":{"line":50,"column":8},"end":{"line":51,"column":57}}],"line":50},"9":{"loc":{"start":{"line":54,"column":8},"end":{"line":55,"column":57}},"type":"if","locations":[{"start":{"line":54,"column":8},"end":{"line":55,"column":57}},{"start":{"line":54,"column":8},"end":{"line":55,"column":57}}],"line":54},"10":{"loc":{"start":{"line":57,"column":8},"end":{"line":58,"column":66}},"type":"if","locations":[{"start":{"line":57,"column":8},"end":{"line":58,"column":66}},{"start":{"line":57,"column":8},"end":{"line":58,"column":66}}],"line":57},"11":{"loc":{"start":{"line":71,"column":21},"end":{"line":71,"column":43}},"type":"default-arg","locations":[{"start":{"line":71,"column":32},"end":{"line":71,"column":43}}],"line":71},"12":{"loc":{"start":{"line":73,"column":8},"end":{"line":76,"column":9}},"type":"if","locations":[{"start":{"line":73,"column":8},"end":{"line":76,"column":9}},{"start":{"line":73,"column":8},"end":{"line":76,"column":9}}],"line":73},"13":{"loc":{"start":{"line":78,"column":8},"end":{"line":79,"column":68}},"type":"if","locations":[{"start":{"line":78,"column":8},"end":{"line":79,"column":68}},{"start":{"line":78,"column":8},"end":{"line":79,"column":68}}],"line":78},"14":{"loc":{"start":{"line":80,"column":8},"end":{"line":81,"column":89}},"type":"if","locations":[{"start":{"line":80,"column":8},"end":{"line":81,"column":89}},{"start":{"line":80,"column":8},"end":{"line":81,"column":89}}],"line":80},"15":{"loc":{"start":{"line":82,"column":8},"end":{"line":88,"column":9}},"type":"switch","locations":[{"start":{"line":83,"column":12},"end":{"line":85,"column":22}},{"start":{"line":86,"column":12},"end":{"line":87,"column":58}}],"line":82}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":7,"10":7,"11":7,"12":7,"13":0,"14":7,"15":0,"16":7,"17":30,"18":30,"19":60,"20":30,"21":30,"22":60,"23":0,"24":60,"25":30,"26":1,"27":30,"28":30,"29":30,"30":0,"31":30,"32":0,"33":30,"34":30,"35":0,"36":30,"37":30,"38":30,"39":0,"40":30,"41":30,"42":0,"43":30,"44":30,"45":1,"46":5,"47":43,"48":43,"49":6,"50":6,"51":37,"52":37,"53":0,"54":37,"55":0,"56":37,"57":7,"58":7,"59":30,"60":37,"61":1},"f":{"0":7,"1":7,"2":30,"3":30,"4":30,"5":5,"6":43,"7":43},"b":{"0":[0,7],"1":[0,7],"2":[30,30],"3":[0,60],"4":[30,0],"5":[30,30],"6":[0,30],"7":[0,30],"8":[0,30],"9":[0,30],"10":[0,30],"11":[2],"12":[6,37],"13":[0,37],"14":[0,37],"15":[7,30]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\auth\\handler.ts","sources":["C:\\dev\\quicksend-server\\src\\auth\\handler.ts"],"names":[],"mappings":"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","sourcesContent":["import Koa from \"koa\";\nimport mongoose from \"mongoose\";\nimport crypto from \"crypto\";\nimport bcrypt from \"bcryptjs\";\nimport parseAuthorization from \"./parse\";\nimport {\n\tBasicAuthorizationRequest,\n\tSignatureAuthorizationRequest\n} from \"./schemes\";\nimport { includesAll } from \"src/utils\";\nimport userManager from \"src/control/user_manager\";\nimport deviceManager from \"src/control/device_manager\";\nimport { isValidID } from \"src/control/utils\";\n\ninterface UserData {\n\tid: mongoose.Types.ObjectId;\n\tusername: string;\n\tdisplay?: string;\n}\n\nasync function authenticateBasic(\n\tctx: Koa.Context,\n\treq: BasicAuthorizationRequest\n) {\n\tconst { username, password } = req;\n\tconst user = await userManager.findUsername(username);\n\tif (!user) return ctx.throw(400, \"User doesn't exist\");\n\tif (!bcrypt.compareSync(password, user.get(\"passwordHash\")))\n\t\treturn ctx.throw(401, \"Invalid credentials\");\n\tctx.state.user = {\n\t\tid: user.id,\n\t\tusername: user.get(\"username\"),\n\t\tdisplay: user.get(\"display\")\n\t} as UserData;\n}\n\nfunction createSignatureString(ctx: Koa.Context, headers: string[]) {\n\tlet signatureStr = \"\";\n\tfor (const header of headers) {\n\t\tlet value: string;\n\t\tif (header == \"(request-target)\")\n\t\t\tvalue = `${ctx.method.toLowerCase()} ${ctx.url}`;\n\t\telse value = ctx.get(header);\n\t\tif (!value)\n\t\t\treturn ctx.throw(\n\t\t\t\t400,\n\t\t\t\t`Cannot use unspecified header '${header}' for signature`\n\t\t\t);\n\t\tsignatureStr += `${header}: ${value}\\n`;\n\t}\n\treturn signatureStr;\n}\n\nconst signatureRequiredHeaders = [\"(request-target)\", \"date\"];\n\nasync function authenticateSignature(\n\tctx: Koa.Context,\n\treq: SignatureAuthorizationRequest\n) {\n\tconst headers = req.headers ?? [\"date\"];\n\tif (!includesAll(headers, ...signatureRequiredHeaders))\n\t\treturn ctx.throw(400, \"missing reqired header for signature\");\n\tif (!isValidID(req.keyId)) ctx.throw(400, \"invalid device id\");\n\tconst device = await deviceManager.findID(\n\t\treq.keyId,\n\t\t\"signaturePublicKey user\"\n\t);\n\tif (!device) return ctx.throw(401, \"Unregistered device\");\n\n\tconst signatureStr = createSignatureString(ctx, headers);\n\tconst result = crypto.verify(\n\t\treq.algorithm,\n\t\tBuffer.from(signatureStr),\n\t\tdevice.get(\"signaturePublicKey\"),\n\t\tBuffer.from(req.signature, \"base64\")\n\t);\n\tif (!result) return ctx.throw(401, \"Incorrect signature\");\n\n\tconst user = await userManager.findID(device.get(\"user\"));\n\tif (!user) ctx.throw(500, \"Could not find user for this device\");\n\tctx.state.user = {\n\t\tid: user.id,\n\t\tusername: user.get(\"username\"),\n\t\tdisplay: user.get(\"display\")\n\t} as UserData;\n\tctx.state.device = device.id;\n}\n\ntype AuthType = \"Basic\" | \"Signature\";\n\nconst authenticateHeaderMap: Record<AuthType, string> = {\n\tBasic: 'Basic charset=\"utf-8\"',\n\tSignature: `Signature headers=\"${signatureRequiredHeaders.join(\n\t\t\" \"\n\t)}\",charset=\"utf-8\"`\n};\n\nfunction authHandler(authType: AuthType = \"Signature\"): Koa.Middleware {\n\treturn async (ctx, next) => {\n\t\tif (!ctx.get(\"Authorization\")) {\n\t\t\tctx.set(\"WWW-Authenticate\", authenticateHeaderMap[authType]);\n\t\t\treturn ctx.throw(401, \"Unauthorized\");\n\t\t}\n\t\tconst authReq = parseAuthorization(ctx.get(\"Authorization\"));\n\t\tif (!authReq) return ctx.throw(400, \"Malformed authorization header\");\n\t\tif (authReq.name != authType)\n\t\t\treturn ctx.throw(\n\t\t\t\t400,\n\t\t\t\t\"Authorization scheme not supported for this request\"\n\t\t\t);\n\t\tswitch (authReq.name) {\n\t\t\tcase \"Basic\":\n\t\t\t\tawait authenticateBasic(ctx, authReq);\n\t\t\t\tbreak;\n\t\t\tcase \"Signature\":\n\t\t\t\tawait authenticateSignature(ctx, authReq);\n\t\t}\n\t\treturn next();\n\t};\n}\n\nexport default authHandler;\nexport type { UserData };\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"cca68a4fa2441b966130855545daca5f1a8cba27","contentHash":"e376fd5fa99e19bf94f7baa9afdc7d342423541fc81e4721eb61564f3d08d321"},"C:\\dev\\quicksend-server\\src\\auth\\parse.ts":{"path":"C:\\dev\\quicksend-server\\src\\auth\\parse.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":36}},"2":{"start":{"line":4,"column":18},"end":{"line":4,"column":38}},"3":{"start":{"line":6,"column":4},"end":{"line":6,"column":68}},"4":{"start":{"line":9,"column":53},"end":{"line":9,"column":59}},"5":{"start":{"line":10,"column":4},"end":{"line":11,"column":20}},"6":{"start":{"line":11,"column":8},"end":{"line":11,"column":20}},"7":{"start":{"line":12,"column":4},"end":{"line":17,"column":7}},"8":{"start":{"line":20,"column":20},"end":{"line":20,"column":58}},"9":{"start":{"line":21,"column":16},"end":{"line":21,"column":50}},"10":{"start":{"line":22,"column":4},"end":{"line":23,"column":20}},"11":{"start":{"line":23,"column":8},"end":{"line":23,"column":20}},"12":{"start":{"line":24,"column":4},"end":{"line":24,"column":67}},"13":{"start":{"line":28,"column":19},"end":{"line":28,"column":21}},"14":{"start":{"line":29,"column":30},"end":{"line":29,"column":52}},"15":{"start":{"line":30,"column":4},"end":{"line":41,"column":5}},"16":{"start":{"line":31,"column":8},"end":{"line":32,"column":21}},"17":{"start":{"line":32,"column":12},"end":{"line":32,"column":21}},"18":{"start":{"line":33,"column":20},"end":{"line":35,"column":66}},"19":{"start":{"line":36,"column":8},"end":{"line":37,"column":24}},"20":{"start":{"line":37,"column":12},"end":{"line":37,"column":24}},"21":{"start":{"line":38,"column":20},"end":{"line":38,"column":26}},"22":{"start":{"line":39,"column":20},"end":{"line":39,"column":73}},"23":{"start":{"line":40,"column":8},"end":{"line":40,"column":26}},"24":{"start":{"line":42,"column":4},"end":{"line":42,"column":18}},"25":{"start":{"line":46,"column":4},"end":{"line":47,"column":20}},"26":{"start":{"line":47,"column":8},"end":{"line":47,"column":20}},"27":{"start":{"line":48,"column":23},"end":{"line":48,"column":43}},"28":{"start":{"line":49,"column":16},"end":{"line":49,"column":63}},"29":{"start":{"line":50,"column":4},"end":{"line":51,"column":20}},"30":{"start":{"line":51,"column":8},"end":{"line":51,"column":20}},"31":{"start":{"line":52,"column":19},"end":{"line":52,"column":25}},"32":{"start":{"line":53,"column":24},"end":{"line":53,"column":73}},"33":{"start":{"line":54,"column":19},"end":{"line":54,"column":83}},"34":{"start":{"line":55,"column":4},"end":{"line":64,"column":5}},"35":{"start":{"line":57,"column":12},"end":{"line":57,"column":47}},"36":{"start":{"line":59,"column":12},"end":{"line":60,"column":28}},"37":{"start":{"line":60,"column":16},"end":{"line":60,"column":28}},"38":{"start":{"line":61,"column":12},"end":{"line":61,"column":46}},"39":{"start":{"line":63,"column":12},"end":{"line":63,"column":63}},"40":{"start":{"line":66,"column":0},"end":{"line":66,"column":37}}},"fnMap":{"0":{"name":"parseHeaders","decl":{"start":{"line":5,"column":9},"end":{"line":5,"column":21}},"loc":{"start":{"line":5,"column":36},"end":{"line":7,"column":1}},"line":5},"1":{"name":"parseSignatureAuth","decl":{"start":{"line":8,"column":9},"end":{"line":8,"column":27}},"loc":{"start":{"line":8,"column":36},"end":{"line":18,"column":1}},"line":8},"2":{"name":"parseBasicAuth","decl":{"start":{"line":19,"column":9},"end":{"line":19,"column":23}},"loc":{"start":{"line":19,"column":37},"end":{"line":25,"column":1}},"line":19},"3":{"name":"parseAuthorizationParams","decl":{"start":{"line":26,"column":9},"end":{"line":26,"column":33}},"loc":{"start":{"line":26,"column":47},"end":{"line":43,"column":1}},"line":26},"4":{"name":"parseAuthorization","decl":{"start":{"line":44,"column":9},"end":{"line":44,"column":27}},"loc":{"start":{"line":44,"column":43},"end":{"line":65,"column":1}},"line":44}},"branchMap":{"0":{"loc":{"start":{"line":10,"column":4},"end":{"line":11,"column":20}},"type":"if","locations":[{"start":{"line":10,"column":4},"end":{"line":11,"column":20}},{"start":{"line":10,"column":4},"end":{"line":11,"column":20}}],"line":10},"1":{"loc":{"start":{"line":10,"column":8},"end":{"line":10,"column":28}},"type":"binary-expr","locations":[{"start":{"line":10,"column":8},"end":{"line":10,"column":14}},{"start":{"line":10,"column":18},"end":{"line":10,"column":28}}],"line":10},"2":{"loc":{"start":{"line":15,"column":17},"end":{"line":15,"column":60}},"type":"cond-expr","locations":[{"start":{"line":15,"column":27},"end":{"line":15,"column":48}},{"start":{"line":15,"column":51},"end":{"line":15,"column":60}}],"line":15},"3":{"loc":{"start":{"line":22,"column":4},"end":{"line":23,"column":20}},"type":"if","locations":[{"start":{"line":22,"column":4},"end":{"line":23,"column":20}},{"start":{"line":22,"column":4},"end":{"line":23,"column":20}}],"line":22},"4":{"loc":{"start":{"line":31,"column":8},"end":{"line":32,"column":21}},"type":"if","locations":[{"start":{"line":31,"column":8},"end":{"line":32,"column":21}},{"start":{"line":31,"column":8},"end":{"line":32,"column":21}}],"line":31},"5":{"loc":{"start":{"line":36,"column":8},"end":{"line":37,"column":24}},"type":"if","locations":[{"start":{"line":36,"column":8},"end":{"line":37,"column":24}},{"start":{"line":36,"column":8},"end":{"line":37,"column":24}}],"line":36},"6":{"loc":{"start":{"line":39,"column":20},"end":{"line":39,"column":73}},"type":"cond-expr","locations":[{"start":{"line":39,"column":62},"end":{"line":39,"column":64}},{"start":{"line":39,"column":67},"end":{"line":39,"column":73}}],"line":39},"7":{"loc":{"start":{"line":39,"column":20},"end":{"line":39,"column":59}},"type":"binary-expr","locations":[{"start":{"line":39,"column":20},"end":{"line":39,"column":42}},{"start":{"line":39,"column":46},"end":{"line":39,"column":59}}],"line":39},"8":{"loc":{"start":{"line":46,"column":4},"end":{"line":47,"column":20}},"type":"if","locations":[{"start":{"line":46,"column":4},"end":{"line":47,"column":20}},{"start":{"line":46,"column":4},"end":{"line":47,"column":20}}],"line":46},"9":{"loc":{"start":{"line":50,"column":4},"end":{"line":51,"column":20}},"type":"if","locations":[{"start":{"line":50,"column":4},"end":{"line":51,"column":20}},{"start":{"line":50,"column":4},"end":{"line":51,"column":20}}],"line":50},"10":{"loc":{"start":{"line":53,"column":24},"end":{"line":53,"column":73}},"type":"cond-expr","locations":[{"start":{"line":53,"column":66},"end":{"line":53,"column":68}},{"start":{"line":53,"column":71},"end":{"line":53,"column":73}}],"line":53},"11":{"loc":{"start":{"line":53,"column":24},"end":{"line":53,"column":63}},"type":"binary-expr","locations":[{"start":{"line":53,"column":24},"end":{"line":53,"column":46}},{"start":{"line":53,"column":50},"end":{"line":53,"column":63}}],"line":53},"12":{"loc":{"start":{"line":54,"column":19},"end":{"line":54,"column":83}},"type":"cond-expr","locations":[{"start":{"line":54,"column":39},"end":{"line":54,"column":76}},{"start":{"line":54,"column":79},"end":{"line":54,"column":83}}],"line":54},"13":{"loc":{"start":{"line":55,"column":4},"end":{"line":64,"column":5}},"type":"switch","locations":[{"start":{"line":56,"column":8},"end":{"line":57,"column":47}},{"start":{"line":58,"column":8},"end":{"line":61,"column":46}},{"start":{"line":62,"column":8},"end":{"line":63,"column":63}}],"line":55},"14":{"loc":{"start":{"line":59,"column":12},"end":{"line":60,"column":28}},"type":"if","locations":[{"start":{"line":59,"column":12},"end":{"line":60,"column":28}},{"start":{"line":59,"column":12},"end":{"line":60,"column":28}}],"line":59}},"s":{"0":1,"1":1,"2":1,"3":30,"4":30,"5":30,"6":0,"7":30,"8":7,"9":7,"10":7,"11":0,"12":7,"13":30,"14":30,"15":30,"16":90,"17":0,"18":90,"19":90,"20":0,"21":90,"22":90,"23":90,"24":30,"25":37,"26":0,"27":37,"28":37,"29":37,"30":0,"31":37,"32":37,"33":37,"34":37,"35":7,"36":30,"37":0,"38":30,"39":0,"40":1},"f":{"0":30,"1":30,"2":7,"3":30,"4":37},"b":{"0":[0,30],"1":[30,30],"2":[30,0],"3":[0,7],"4":[0,90],"5":[0,90],"6":[90,0],"7":[90,90],"8":[0,37],"9":[0,37],"10":[37,0],"11":[37,37],"12":[30,7],"13":[7,30,0],"14":[0,30]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\authorization\\parse.ts","sources":["C:\\dev\\quicksend-server\\src\\authorization\\parse.ts"],"names":[],"mappings":";;AAAA,qCAA6D;AAC7D,uCAKmB;AAEnB,SAAS,YAAY,CAAC,YAAoB;IACzC,OAAO,IAAA,0BAAkB,EAAC,YAAY,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;AACpD,CAAC;AAED,SAAS,kBAAkB,CAC1B,MAA8B;IAE9B,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,OAAO,EAAE,SAAS,EAAE,GAAG,MAAM,CAAC;IACxD,IAAI,CAAC,KAAK,IAAI,CAAC,SAAS;QAAE,OAAO,IAAI,CAAC;IACtC,OAAO,IAAI,uCAA6B,CAAC;QACxC,KAAK;QACL,SAAS;QACT,OAAO,EAAE,OAAO,CAAC,CAAC,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,SAAS;QACpD,SAAS;KACT,CAAC,CAAC;AACJ,CAAC;AAED,SAAS,cAAc,CAAC,WAAmB;IAC1C,MAAM,OAAO,GAAG,IAAA,oBAAY,EAAC,WAAW,CAAC,CAAC;IAC1C,MAAM,GAAG,GAAG,OAAO,CAAC,KAAK,CAAC,mBAAmB,CAAC,CAAC;IAC/C,IAAI,CAAC,GAAG;QAAE,OAAO,IAAI,CAAC;IACtB,OAAO,IAAI,mCAAyB,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;AACtD,CAAC;AAED,SAAS,wBAAwB,CAChC,WAAmB;;IAEnB,MAAM,MAAM,GAA2B,EAAE,CAAC;IAC1C,MAAM,iBAAiB,GAAG,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IACjD,KAAK,MAAM,gBAAgB,IAAI,iBAAiB,EAAE;QACjD,IAAI,CAAC,gBAAgB;YAAE,SAAS;QAChC,MAAM,GAAG,GAAG,gBAAgB;aAC1B,IAAI,EAAE;aACN,KAAK,CAAC,8CAA8C,CAAC,CAAC;QACxD,IAAI,CAAC,GAAG;YAAE,OAAO,IAAI,CAAC;QACtB,MAAM,GAAG,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC;QACnB,MAAM,GAAG,GAAG,MAAA,GAAG,CAAC,CAAC,CAAC,mCAAI,GAAG,CAAC,CAAC,CAAC,CAAC;QAC7B,MAAM,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC;KAClB;IACD,OAAO,MAAM,CAAC;AACf,CAAC;AAED,SAAS,kBAAkB,CAC1B,aAAqB;;IAErB,IAAI,CAAC,aAAa;QAAE,OAAO,IAAI,CAAC;IAChC,MAAM,UAAU,GAAG,aAAa,CAAC,IAAI,EAAE,CAAC;IACxC,MAAM,GAAG,GAAG,UAAU,CAAC,KAAK,CAAC,6BAA6B,CAAC,CAAC;IAC5D,IAAI,CAAC,GAAG;QAAE,OAAO,IAAI,CAAC;IACtB,MAAM,MAAM,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC;IACtB,MAAM,WAAW,GAAG,MAAA,GAAG,CAAC,CAAC,CAAC,mCAAI,EAAE,CAAC;IACjC,MAAM,MAAM,GACX,MAAM,IAAI,OAAO,CAAC,CAAC,CAAC,wBAAwB,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;IAClE,QAAQ,MAAM,EAAE;QACf,KAAK,OAAO;YACX,OAAO,cAAc,CAAC,WAAW,CAAC,CAAC;QACpC,KAAK,WAAW;YACf,IAAI,CAAC,MAAM;gBAAE,OAAO,IAAI,CAAC;YACzB,OAAO,kBAAkB,CAAC,MAAM,CAAC,CAAC;QACnC;YACC,OAAO,IAAI,qCAA2B,EAAE,CAAC;KAC1C;AACF,CAAC;AAED,kBAAe,kBAAkB,CAAC","sourcesContent":["import { collapseWhitespace, decodeBase64 } from \"src/utils\";\r\nimport {\r\n\tAuthorizationRequest,\r\n\tBasicAuthorizationRequest,\r\n\tSignatureAuthorizationRequest,\r\n\tUnknownAuthorizationRequest\r\n} from \"./schemes\";\r\n\r\nfunction parseHeaders(headerString: string): string[] {\r\n\treturn collapseWhitespace(headerString).split(\" \");\r\n}\r\n\r\nfunction parseSignatureAuth(\r\n\tparams: Record<string, string>\r\n): SignatureAuthorizationRequest | null {\r\n\tconst { keyId, signature, headers, algorithm } = params;\r\n\tif (!keyId || !signature) return null;\r\n\treturn new SignatureAuthorizationRequest({\r\n\t\tkeyId,\r\n\t\tsignature,\r\n\t\theaders: headers ? parseHeaders(headers) : undefined,\r\n\t\talgorithm\r\n\t});\r\n}\r\n\r\nfunction parseBasicAuth(paramString: string): BasicAuthorizationRequest | null {\r\n\tconst decoded = decodeBase64(paramString);\r\n\tconst res = decoded.match(/^([^:]+):([^:]+)$/);\r\n\tif (!res) return null;\r\n\treturn new BasicAuthorizationRequest(res[1], res[2]);\r\n}\r\n\r\nfunction parseAuthorizationParams(\r\n\tparamString: string\r\n): Record<string, string> | null {\r\n\tconst params: Record<string, string> = {};\r\n\tconst assignmentStrings = paramString.split(\",\");\r\n\tfor (const assignmentString of assignmentStrings) {\r\n\t\tif (!assignmentString) continue;\r\n\t\tconst res = assignmentString\r\n\t\t\t.trim()\r\n\t\t\t.match(/^([a-z0-9_-]+) *= *(?:\"([^\"]*)\"|'([^']*)')$/i);\r\n\t\tif (!res) return null;\r\n\t\tconst key = res[1];\r\n\t\tconst val = res[2] ?? res[3];\r\n\t\tparams[key] = val;\r\n\t}\r\n\treturn params;\r\n}\r\n\r\nfunction parseAuthorization(\r\n\tauthorization: string\r\n): AuthorizationRequest | null {\r\n\tif (!authorization) return null;\r\n\tconst normalized = authorization.trim();\r\n\tconst res = normalized.match(/^([a-z0-9_-]+)(?: +(.+))?$/i);\r\n\tif (!res) return null;\r\n\tconst schema = res[1];\r\n\tconst paramString = res[2] ?? \"\";\r\n\tconst params =\r\n\t\tschema != \"Basic\" ? parseAuthorizationParams(paramString) : null;\r\n\tswitch (schema) {\r\n\t\tcase \"Basic\":\r\n\t\t\treturn parseBasicAuth(paramString);\r\n\t\tcase \"Signature\":\r\n\t\t\tif (!params) return null;\r\n\t\t\treturn parseSignatureAuth(params);\r\n\t\tdefault:\r\n\t\t\treturn new UnknownAuthorizationRequest();\r\n\t}\r\n}\r\n\r\nexport default parseAuthorization;\r\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"95dd0018fd2a99b3a377eb42e73b6f4a4a09cfe9","contentHash":"36aebd07f52d3e0d6dcc2499cdad2b916ebe913364f6c468cf93885571b819c4"},"C:\\dev\\quicksend-server\\src\\auth\\schemes.ts":{"path":"C:\\dev\\quicksend-server\\src\\auth\\schemes.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":0},"end":{"line":3,"column":121}},"2":{"start":{"line":6,"column":8},"end":{"line":6,"column":25}},"3":{"start":{"line":11,"column":8},"end":{"line":11,"column":25}},"4":{"start":{"line":14,"column":0},"end":{"line":14,"column":66}},"5":{"start":{"line":17,"column":8},"end":{"line":17,"column":23}},"6":{"start":{"line":18,"column":8},"end":{"line":18,"column":33}},"7":{"start":{"line":19,"column":8},"end":{"line":19,"column":33}},"8":{"start":{"line":22,"column":0},"end":{"line":22,"column":62}},"9":{"start":{"line":25,"column":8},"end":{"line":25,"column":27}},"10":{"start":{"line":26,"column":8},"end":{"line":26,"column":27}},"11":{"start":{"line":27,"column":8},"end":{"line":27,"column":35}},"12":{"start":{"line":28,"column":8},"end":{"line":28,"column":31}},"13":{"start":{"line":29,"column":8},"end":{"line":29,"column":35}},"14":{"start":{"line":32,"column":0},"end":{"line":32,"column":70}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":5,"column":4},"end":{"line":5,"column":5}},"loc":{"start":{"line":5,"column":22},"end":{"line":7,"column":5}},"line":5},"1":{"name":"(anonymous_1)","decl":{"start":{"line":10,"column":4},"end":{"line":10,"column":5}},"loc":{"start":{"line":10,"column":18},"end":{"line":12,"column":5}},"line":10},"2":{"name":"(anonymous_2)","decl":{"start":{"line":16,"column":4},"end":{"line":16,"column":5}},"loc":{"start":{"line":16,"column":36},"end":{"line":20,"column":5}},"line":16},"3":{"name":"(anonymous_3)","decl":{"start":{"line":24,"column":4},"end":{"line":24,"column":5}},"loc":{"start":{"line":24,"column":58},"end":{"line":30,"column":5}},"line":24}},"branchMap":{},"s":{"0":1,"1":1,"2":37,"3":0,"4":1,"5":7,"6":7,"7":7,"8":1,"9":30,"10":30,"11":30,"12":30,"13":30,"14":1},"f":{"0":37,"1":0,"2":7,"3":30},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\authorization\\schemes.ts","sources":["C:\\dev\\quicksend-server\\src\\authorization\\schemes.ts"],"names":[],"mappings":";;;AAEA,MAAM,wBAAwB;IAG7B,YAAY,IAAO;QAClB,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;IAClB,CAAC;CACD;AAED,MAAM,2BAA4B,SAAQ,wBAAmC;IAC5E;QACC,KAAK,CAAC,SAAS,CAAC,CAAC;IAClB,CAAC;CACD;AAmDA,kEAA2B;AAjD5B,MAAM,yBAA0B,SAAQ,wBAAiC;IAIxE,YAAY,QAAgB,EAAE,QAAgB;QAC7C,KAAK,CAAC,OAAO,CAAC,CAAC;QACf,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;QACzB,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;IAC1B,CAAC;CACD;AAsCA,8DAAyB;AA7B1B,MAAM,6BACL,SAAQ,wBAAqC;IAQ7C,YAAY,EACX,KAAK,EACL,SAAS,EACT,OAAO,EACP,SAAS,EAC0B;QACnC,KAAK,CAAC,WAAW,CAAC,CAAC;QACnB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;IAC5B,CAAC;CACD;AASA,sEAA6B","sourcesContent":["type AuthorizationScheme = \"Basic\" | \"Signature\" | \"Unknown\";\n\nclass AuthorizationRequestBase<T extends AuthorizationScheme> {\n\tpublic readonly name: T;\n\n\tconstructor(name: T) {\n\t\tthis.name = name;\n\t}\n}\n\nclass UnknownAuthorizationRequest extends AuthorizationRequestBase<\"Unknown\"> {\n\tconstructor() {\n\t\tsuper(\"Unknown\");\n\t}\n}\n\nclass BasicAuthorizationRequest extends AuthorizationRequestBase<\"Basic\"> {\n\tpublic readonly username;\n\tpublic readonly password;\n\n\tconstructor(username: string, password: string) {\n\t\tsuper(\"Basic\");\n\t\tthis.username = username;\n\t\tthis.password = password;\n\t}\n}\n\ninterface SignatureAuthorizationRequestInit {\n\treadonly keyId: string;\n\treadonly signature: string;\n\treadonly headers?: string[];\n\treadonly algorithm?: string;\n}\n\nclass SignatureAuthorizationRequest\n\textends AuthorizationRequestBase<\"Signature\">\n\timplements SignatureAuthorizationRequestInit\n{\n\tpublic readonly keyId: string;\n\tpublic readonly signature: string;\n\tpublic readonly headers?: string[];\n\tpublic readonly algorithm?: string | undefined;\n\n\tconstructor({\n\t\tkeyId,\n\t\tsignature,\n\t\theaders,\n\t\talgorithm\n\t}: SignatureAuthorizationRequestInit) {\n\t\tsuper(\"Signature\");\n\t\tthis.keyId = keyId;\n\t\tthis.signature = signature;\n\t\tthis.headers = headers;\n\t\tthis.algorithm = algorithm;\n\t}\n}\n\ntype AuthorizationRequest =\n\t| BasicAuthorizationRequest\n\t| SignatureAuthorizationRequest\n\t| UnknownAuthorizationRequest;\n\nexport {\n\tBasicAuthorizationRequest,\n\tSignatureAuthorizationRequest,\n\tUnknownAuthorizationRequest\n};\nexport type { AuthorizationRequest };\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"82d8b7c19558d3357d0ae38576ff7f27833e70fb","contentHash":"c0d392121dc9c3508a13cee33cfe8adad567e8b14ad15a3a1e51ddab97181781"},"C:\\dev\\quicksend-server\\src\\control\\user_manager.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\user_manager.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":15},"end":{"line":4,"column":69}},"3":{"start":{"line":5,"column":18},"end":{"line":5,"column":63}},"4":{"start":{"line":6,"column":26},"end":{"line":6,"column":79}},"5":{"start":{"line":9,"column":8},"end":{"line":9,"column":30}},"6":{"start":{"line":12,"column":8},"end":{"line":15,"column":11}},"7":{"start":{"line":13,"column":24},"end":{"line":13,"column":68}},"8":{"start":{"line":14,"column":12},"end":{"line":14,"column":25}},"9":{"start":{"line":18,"column":8},"end":{"line":23,"column":11}},"10":{"start":{"line":19,"column":24},"end":{"line":19,"column":69}},"11":{"start":{"line":20,"column":12},"end":{"line":21,"column":28}},"12":{"start":{"line":21,"column":16},"end":{"line":21,"column":28}},"13":{"start":{"line":22,"column":12},"end":{"line":22,"column":46}},"14":{"start":{"line":26,"column":8},"end":{"line":26,"column":61}},"15":{"start":{"line":29,"column":20},"end":{"line":29,"column":37}},"16":{"start":{"line":30,"column":0},"end":{"line":30,"column":30}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":8,"column":4},"end":{"line":8,"column":5}},"loc":{"start":{"line":8,"column":18},"end":{"line":10,"column":5}},"line":8},"1":{"name":"(anonymous_1)","decl":{"start":{"line":11,"column":4},"end":{"line":11,"column":5}},"loc":{"start":{"line":11,"column":29},"end":{"line":16,"column":5}},"line":11},"2":{"name":"(anonymous_2)","decl":{"start":{"line":12,"column":55},"end":{"line":12,"column":56}},"loc":{"start":{"line":12,"column":68},"end":{"line":15,"column":9}},"line":12},"3":{"name":"(anonymous_3)","decl":{"start":{"line":17,"column":4},"end":{"line":17,"column":5}},"loc":{"start":{"line":17,"column":27},"end":{"line":24,"column":5}},"line":17},"4":{"name":"(anonymous_4)","decl":{"start":{"line":18,"column":55},"end":{"line":18,"column":56}},"loc":{"start":{"line":18,"column":68},"end":{"line":23,"column":9}},"line":18},"5":{"name":"(anonymous_5)","decl":{"start":{"line":25,"column":4},"end":{"line":25,"column":5}},"loc":{"start":{"line":25,"column":37},"end":{"line":27,"column":5}},"line":25}},"branchMap":{"0":{"loc":{"start":{"line":20,"column":12},"end":{"line":21,"column":28}},"type":"if","locations":[{"start":{"line":20,"column":12},"end":{"line":21,"column":28}},{"start":{"line":20,"column":12},"end":{"line":21,"column":28}}],"line":20}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":3,"7":3,"8":3,"9":7,"10":7,"11":7,"12":0,"13":7,"14":39,"15":1,"16":1},"f":{"0":1,"1":3,"2":3,"3":7,"4":7,"5":39},"b":{"0":[0,7]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\user_manager.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\user_manager.ts"],"names":[],"mappings":";;;AAAA,sEAA2C;AAE3C,gEAAgC;AAEhC,gFAA+C;AAE/C,MAAM,WAAY,SAAQ,iBAA6B;IACtD;QACC,KAAK,CAAC,cAAS,CAAC,CAAC;IAClB,CAAC;IAEK,cAAc,CAAC,QAAgB;;YACpC,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,QAAQ,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;YACzD,OAAO,CAAC,CAAC,GAAG,CAAC;QACd,CAAC;KAAA;IAEK,YAAY,CAAC,QAAgB;;YAClC,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,QAAQ,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;YAC1D,IAAI,CAAC,GAAG;gBAAE,OAAO,IAAI,CAAC;YACtB,OAAO,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC;QACnC,CAAC;KAAA;IAES,gBAAgB,CACzB,QAAmB,EACnB,IAAa;QAEb,OAAO,IAAI,yBAAc,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IAC3C,CAAC;CACD;AAED,MAAM,WAAW,GAAG,IAAI,WAAW,EAAE,CAAC;AAEtC,kBAAe,WAAW,CAAC","sourcesContent":["import UserModel from \"src/db/models/user\";\nimport { User } from \"src/db/schemas/user\";\nimport Manager from \"./manager\";\nimport { Doc } from \"./types\";\nimport UserController from \"./user_controller\";\n\nclass UserManager extends Manager<User, UserController> {\n\tconstructor() {\n\t\tsuper(UserModel);\n\t}\n\n\tasync usernameExists(username: string): Promise<boolean> {\n\t\tconst doc = await this.Model.exists({ username }).exec();\n\t\treturn !!doc;\n\t}\n\n\tasync findUsername(username: string): Promise<UserController | null> {\n\t\tconst doc = await this.Model.findOne({ username }).exec();\n\t\tif (!doc) return null;\n\t\treturn this.createController(doc);\n\t}\n\n\tprotected createController(\n\t\tdocument: Doc<User>,\n\t\tproj?: string\n\t): UserController {\n\t\treturn new UserController(document, proj);\n\t}\n}\n\nconst userManager = new UserManager();\n\nexport default userManager;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"a5245636a80969696e0851420e749a206ccba9e7","contentHash":"1caf0ae48ccf736e3128b666b3981120fd85b31329f08f17e50a3656441ba9a7"},"C:\\dev\\quicksend-server\\src\\control\\manager.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\manager.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":6,"column":8},"end":{"line":6,"column":27}},"3":{"start":{"line":9,"column":8},"end":{"line":14,"column":11}},"4":{"start":{"line":10,"column":24},"end":{"line":10,"column":66}},"5":{"start":{"line":11,"column":12},"end":{"line":12,"column":28}},"6":{"start":{"line":12,"column":16},"end":{"line":12,"column":28}},"7":{"start":{"line":13,"column":12},"end":{"line":13,"column":52}},"8":{"start":{"line":17,"column":8},"end":{"line":21,"column":11}},"9":{"start":{"line":18,"column":24},"end":{"line":18,"column":44}},"10":{"start":{"line":19,"column":12},"end":{"line":19,"column":29}},"11":{"start":{"line":20,"column":12},"end":{"line":20,"column":46}},"12":{"start":{"line":24,"column":8},"end":{"line":26,"column":11}},"13":{"start":{"line":25,"column":12},"end":{"line":25,"column":81}},"14":{"start":{"line":25,"column":61},"end":{"line":25,"column":78}},"15":{"start":{"line":29,"column":8},"end":{"line":33,"column":11}},"16":{"start":{"line":30,"column":24},"end":{"line":30,"column":60}},"17":{"start":{"line":31,"column":12},"end":{"line":32,"column":35}},"18":{"start":{"line":32,"column":16},"end":{"line":32,"column":35}},"19":{"start":{"line":36,"column":8},"end":{"line":39,"column":11}},"20":{"start":{"line":37,"column":29},"end":{"line":37,"column":72}},"21":{"start":{"line":38,"column":12},"end":{"line":38,"column":30}},"22":{"start":{"line":42,"column":8},"end":{"line":42,"column":72}},"23":{"start":{"line":42,"column":38},"end":{"line":42,"column":70}},"24":{"start":{"line":45,"column":0},"end":{"line":45,"column":26}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":5,"column":4},"end":{"line":5,"column":5}},"loc":{"start":{"line":5,"column":23},"end":{"line":7,"column":5}},"line":5},"1":{"name":"(anonymous_1)","decl":{"start":{"line":8,"column":4},"end":{"line":8,"column":5}},"loc":{"start":{"line":8,"column":21},"end":{"line":15,"column":5}},"line":8},"2":{"name":"(anonymous_2)","decl":{"start":{"line":9,"column":55},"end":{"line":9,"column":56}},"loc":{"start":{"line":9,"column":68},"end":{"line":14,"column":9}},"line":9},"3":{"name":"(anonymous_3)","decl":{"start":{"line":16,"column":4},"end":{"line":16,"column":5}},"loc":{"start":{"line":16,"column":17},"end":{"line":22,"column":5}},"line":16},"4":{"name":"(anonymous_4)","decl":{"start":{"line":17,"column":55},"end":{"line":17,"column":56}},"loc":{"start":{"line":17,"column":68},"end":{"line":21,"column":9}},"line":17},"5":{"name":"(anonymous_5)","decl":{"start":{"line":23,"column":4},"end":{"line":23,"column":5}},"loc":{"start":{"line":23,"column":26},"end":{"line":27,"column":5}},"line":23},"6":{"name":"(anonymous_6)","decl":{"start":{"line":24,"column":55},"end":{"line":24,"column":56}},"loc":{"start":{"line":24,"column":68},"end":{"line":26,"column":9}},"line":24},"7":{"name":"(anonymous_7)","decl":{"start":{"line":25,"column":51},"end":{"line":25,"column":52}},"loc":{"start":{"line":25,"column":61},"end":{"line":25,"column":78}},"line":25},"8":{"name":"(anonymous_8)","decl":{"start":{"line":28,"column":4},"end":{"line":28,"column":5}},"loc":{"start":{"line":28,"column":15},"end":{"line":34,"column":5}},"line":28},"9":{"name":"(anonymous_9)","decl":{"start":{"line":29,"column":55},"end":{"line":29,"column":56}},"loc":{"start":{"line":29,"column":68},"end":{"line":33,"column":9}},"line":29},"10":{"name":"(anonymous_10)","decl":{"start":{"line":35,"column":4},"end":{"line":35,"column":5}},"loc":{"start":{"line":35,"column":17},"end":{"line":40,"column":5}},"line":35},"11":{"name":"(anonymous_11)","decl":{"start":{"line":36,"column":55},"end":{"line":36,"column":56}},"loc":{"start":{"line":36,"column":68},"end":{"line":39,"column":9}},"line":36},"12":{"name":"(anonymous_12)","decl":{"start":{"line":41,"column":4},"end":{"line":41,"column":5}},"loc":{"start":{"line":41,"column":39},"end":{"line":43,"column":5}},"line":41},"13":{"name":"(anonymous_13)","decl":{"start":{"line":42,"column":29},"end":{"line":42,"column":30}},"loc":{"start":{"line":42,"column":38},"end":{"line":42,"column":70}},"line":42}},"branchMap":{"0":{"loc":{"start":{"line":11,"column":12},"end":{"line":12,"column":28}},"type":"if","locations":[{"start":{"line":11,"column":12},"end":{"line":12,"column":28}},{"start":{"line":11,"column":12},"end":{"line":12,"column":28}}],"line":11},"1":{"loc":{"start":{"line":31,"column":12},"end":{"line":32,"column":35}},"type":"if","locations":[{"start":{"line":31,"column":12},"end":{"line":32,"column":35}},{"start":{"line":31,"column":12},"end":{"line":32,"column":35}}],"line":31}},"s":{"0":1,"1":1,"2":3,"3":60,"4":60,"5":60,"6":0,"7":60,"8":10,"9":10,"10":10,"11":10,"12":4,"13":4,"14":5,"15":2,"16":2,"17":2,"18":2,"19":13,"20":13,"21":13,"22":15,"23":20,"24":1},"f":{"0":3,"1":60,"2":60,"3":10,"4":10,"5":4,"6":4,"7":5,"8":2,"9":2,"10":13,"11":13,"12":15,"13":20},"b":{"0":[0,60],"1":[2,0]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\manager.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\manager.ts"],"names":[],"mappings":";;;AAKA,MAAe,OAAO;IAGrB,YAAY,KAAwB;QACnC,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;IACpB,CAAC;IAEK,MAAM,CACX,EAAoC,EACpC,IAAa;;YAEb,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,EAAE,EAAE,IAAI,CAAC,CAAC,IAAI,EAAE,CAAC;YACvD,IAAI,CAAC,GAAG;gBAAE,OAAO,IAAI,CAAC;YACtB,OAAO,IAAI,CAAC,gBAAgB,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;QACzC,CAAC;KAAA;IAEK,MAAM,CAAC,IAAgB;;YAC5B,MAAM,GAAG,GAAG,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YACjC,MAAM,GAAG,CAAC,IAAI,EAAE,CAAC;YACjB,OAAO,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC;QACnC,CAAC;KAAA;IAEK,UAAU,CAAC,SAAuB;;YACvC,OAAO,MAAM,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QACtE,CAAC;KAAA;IAEK,MAAM,CAAC,EAAM;;YAClB,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;YACjD,IAAI,GAAG;gBAAE,MAAM,GAAG,CAAC,MAAM,EAAE,CAAC;QAC7B,CAAC;KAAA;IAEK,QAAQ,CAAC,EAAM;;YACpB,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,EAAE,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;YAC7D,OAAO,CAAC,CAAC,QAAQ,CAAC;QACnB,CAAC;KAAA;IAIS,iBAAiB,CAAC,SAAmB,EAAE,IAAa;QAC7D,OAAO,SAAS,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC,CAAC;IACjE,CAAC;CACD;AAED,kBAAe,OAAO,CAAC","sourcesContent":["import mongoose from \"mongoose\";\nimport { DBObject } from \"src/db/schemas/base\";\nimport Controller from \"./controller\";\nimport { Doc, DocInit, ID } from \"./types\";\n\nabstract class Manager<D extends DBObject, C extends Controller<D>> {\n\tprotected readonly Model: mongoose.Model<D>;\n\n\tconstructor(model: mongoose.Model<D>) {\n\t\tthis.Model = model;\n\t}\n\n\tasync findID(\n\t\tid: mongoose.Types.ObjectId | string,\n\t\tproj?: string\n\t): Promise<C | null> {\n\t\tconst doc = await this.Model.findById(id, proj).exec();\n\t\tif (!doc) return null;\n\t\treturn this.createController(doc, proj);\n\t}\n\n\tasync create(data: DocInit<D>): Promise<C> {\n\t\tconst doc = new this.Model(data);\n\t\tawait doc.save();\n\t\treturn this.createController(doc);\n\t}\n\n\tasync createMany(dataArray: DocInit<D>[]): Promise<C[]> {\n\t\treturn await Promise.all(dataArray.map((data) => this.create(data)));\n\t}\n\n\tasync remove(id: ID): Promise<void> {\n\t\tconst doc = await this.Model.findById(id).exec();\n\t\tif (doc) await doc.remove();\n\t}\n\n\tasync idExists(id: ID): Promise<boolean> {\n\t\tconst queryRes = await this.Model.exists({ _id: id }).exec();\n\t\treturn !!queryRes;\n\t}\n\n\tprotected abstract createController(document: Doc<D>, proj?: string): C;\n\n\tprotected createControllers(documents: Doc<D>[], proj?: string): C[] {\n\t\treturn documents.map((doc) => this.createController(doc, proj));\n\t}\n}\n\nexport default Manager;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"90ff42549efc32f6da65ae92e70775a4118935e1","contentHash":"5113cff87bec846e5715139f148e7ea6bb1e1816212392047783324e6ca7fa2a"},"C:\\dev\\quicksend-server\\src\\control\\user_controller.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\user_controller.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":21},"end":{"line":4,"column":69}},"3":{"start":{"line":7,"column":8},"end":{"line":7,"column":30}},"4":{"start":{"line":10,"column":0},"end":{"line":10,"column":33}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":6,"column":4},"end":{"line":6,"column":5}},"loc":{"start":{"line":6,"column":32},"end":{"line":8,"column":5}},"line":6}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":39,"4":1},"f":{"0":39},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\user_controller.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\user_controller.ts"],"names":[],"mappings":";;;AACA,sEAAsC;AAGtC,MAAM,cAAe,SAAQ,oBAAgB;IAC5C,YAAY,QAAmB,EAAE,IAAa;QAC7C,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IACvB,CAAC;CACD;AAED,kBAAe,cAAc,CAAC","sourcesContent":["import { User } from \"src/db/schemas/user\";\nimport Controller from \"./controller\";\nimport { Doc } from \"./types\";\n\nclass UserController extends Controller<User> {\n\tconstructor(document: Doc<User>, proj?: string) {\n\t\tsuper(document, proj);\n\t}\n}\n\nexport default UserController;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"23e5cfdac2d66d0d2a52d75dc036567dc67d123e","contentHash":"8963b02fb3cad015c1109218c8d94cb9c69cc965102805f051fcac698418ccea"},"C:\\dev\\quicksend-server\\src\\control\\controller.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\controller.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":6,"column":8},"end":{"line":6,"column":147}},"3":{"start":{"line":7,"column":8},"end":{"line":7,"column":35}},"4":{"start":{"line":8,"column":8},"end":{"line":8,"column":27}},"5":{"start":{"line":13,"column":8},"end":{"line":13,"column":29}},"6":{"start":{"line":14,"column":8},"end":{"line":14,"column":59}},"7":{"start":{"line":17,"column":8},"end":{"line":17,"column":35}},"8":{"start":{"line":20,"column":8},"end":{"line":20,"column":29}},"9":{"start":{"line":23,"column":8},"end":{"line":24,"column":67}},"10":{"start":{"line":24,"column":12},"end":{"line":24,"column":67}},"11":{"start":{"line":25,"column":22},"end":{"line":25,"column":38}},"12":{"start":{"line":26,"column":8},"end":{"line":26,"column":21}},"13":{"start":{"line":29,"column":8},"end":{"line":31,"column":11}},"14":{"start":{"line":30,"column":12},"end":{"line":30,"column":44}},"15":{"start":{"line":34,"column":8},"end":{"line":35,"column":24}},"16":{"start":{"line":35,"column":12},"end":{"line":35,"column":24}},"17":{"start":{"line":36,"column":8},"end":{"line":36,"column":50}},"18":{"start":{"line":39,"column":0},"end":{"line":39,"column":29}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":5,"column":4},"end":{"line":5,"column":5}},"loc":{"start":{"line":5,"column":34},"end":{"line":9,"column":5}},"line":5},"1":{"name":"(anonymous_1)","decl":{"start":{"line":12,"column":4},"end":{"line":12,"column":5}},"loc":{"start":{"line":12,"column":32},"end":{"line":15,"column":5}},"line":12},"2":{"name":"(anonymous_2)","decl":{"start":{"line":16,"column":4},"end":{"line":16,"column":5}},"loc":{"start":{"line":16,"column":20},"end":{"line":18,"column":5}},"line":16},"3":{"name":"(anonymous_3)","decl":{"start":{"line":19,"column":4},"end":{"line":19,"column":5}},"loc":{"start":{"line":19,"column":13},"end":{"line":21,"column":5}},"line":19},"4":{"name":"(anonymous_4)","decl":{"start":{"line":22,"column":4},"end":{"line":22,"column":5}},"loc":{"start":{"line":22,"column":15},"end":{"line":27,"column":5}},"line":22},"5":{"name":"(anonymous_5)","decl":{"start":{"line":28,"column":4},"end":{"line":28,"column":5}},"loc":{"start":{"line":28,"column":13},"end":{"line":32,"column":5}},"line":28},"6":{"name":"(anonymous_6)","decl":{"start":{"line":29,"column":55},"end":{"line":29,"column":56}},"loc":{"start":{"line":29,"column":68},"end":{"line":31,"column":9}},"line":29},"7":{"name":"(anonymous_7)","decl":{"start":{"line":33,"column":4},"end":{"line":33,"column":5}},"loc":{"start":{"line":33,"column":26},"end":{"line":37,"column":5}},"line":33}},"branchMap":{"0":{"loc":{"start":{"line":14,"column":29},"end":{"line":14,"column":58}},"type":"cond-expr","locations":[{"start":{"line":14,"column":36},"end":{"line":14,"column":51}},{"start":{"line":14,"column":54},"end":{"line":14,"column":58}}],"line":14},"1":{"loc":{"start":{"line":23,"column":8},"end":{"line":24,"column":67}},"type":"if","locations":[{"start":{"line":23,"column":8},"end":{"line":24,"column":67}},{"start":{"line":23,"column":8},"end":{"line":24,"column":67}}],"line":23},"2":{"loc":{"start":{"line":34,"column":8},"end":{"line":35,"column":24}},"type":"if","locations":[{"start":{"line":34,"column":8},"end":{"line":35,"column":24}},{"start":{"line":34,"column":8},"end":{"line":35,"column":24}}],"line":34}},"s":{"0":1,"1":1,"2":0,"3":0,"4":0,"5":97,"6":97,"7":0,"8":85,"9":168,"10":0,"11":168,"12":168,"13":0,"14":0,"15":168,"16":81,"17":87,"18":1},"f":{"0":0,"1":97,"2":0,"3":85,"4":168,"5":0,"6":0,"7":168},"b":{"0":[50,47],"1":[0,168],"2":[81,87]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\controller.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\controller.ts"],"names":[],"mappings":";;;AAGA,MAAM,qBAAsB,SAAQ,KAAK;IAIxC,YAAY,SAAiB,EAAE,KAAa;QAC3C,KAAK,CACJ,KAAK,SAAS,0CAA0C,KAAK,sEAAsE,CACnI,CAAC;QACF,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;IACpB,CAAC;CACD;AAED,MAAM,UAAU;IAIf,YAAY,QAAgB,EAAE,IAAa;QAC1C,IAAI,CAAC,IAAI,GAAG,QAAQ,CAAC;QACrB,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;IACpD,CAAC;IAED,IAAI,SAAS;QACZ,OAAO,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC;IAC5B,CAAC;IAED,IAAI,EAAE;QACL,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC;IACtB,CAAC;IAED,GAAG,CAA6C,KAAQ;QACvD,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC;YAC9B,MAAM,IAAI,qBAAqB,CAAC,IAAI,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;QACxD,MAAM,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC/B,OAAO,KAAK,CAAC;IACd,CAAC;IAEK,MAAM;;YACX,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;QACjC,CAAC;KAAA;IAEO,cAAc,CAAC,KAAa;QACnC,IAAI,CAAC,IAAI,CAAC,aAAa;YAAE,OAAO,IAAI,CAAC;QACrC,OAAO,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;IAC3C,CAAC;CACD;AAED,kBAAe,UAAU,CAAC","sourcesContent":["import { DBObject } from \"src/db/schemas/base\";\nimport { Doc, ObjectId } from \"./types\";\n\nclass ProjectionAccessError extends Error {\n\tpublic readonly modelName: string;\n\tpublic readonly field: string;\n\n\tconstructor(modelName: string, field: string) {\n\t\tsuper(\n\t\t\t`A ${modelName} controller tried to access the field '${field}', which was not defined in the projection provided at its creation.`\n\t\t);\n\t\tthis.modelName = modelName;\n\t\tthis.field = field;\n\t}\n}\n\nclass Controller<D extends DBObject> {\n\tprivate readonly _doc: Doc<D>;\n\tprivate readonly definedFields: readonly string[] | null;\n\n\tconstructor(document: Doc<D>, proj?: string) {\n\t\tthis._doc = document;\n\t\tthis.definedFields = proj ? proj.split(\" \") : null;\n\t}\n\n\tget modelName(): string {\n\t\treturn this._doc.modelName;\n\t}\n\n\tget id(): ObjectId {\n\t\treturn this._doc._id;\n\t}\n\n\tget<F extends Exclude<keyof D & string, \"_id\">>(field: F): D[F] {\n\t\tif (!this.isFieldDefined(field))\n\t\t\tthrow new ProjectionAccessError(this.modelName, field);\n\t\tconst value = this._doc[field];\n\t\treturn value;\n\t}\n\n\tasync delete() {\n\t\treturn await this._doc.delete();\n\t}\n\n\tprivate isFieldDefined(field: string) {\n\t\tif (!this.definedFields) return true;\n\t\treturn this.definedFields.includes(field);\n\t}\n}\n\nexport default Controller;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"d91ad48d0dca137b8f59d200661ae2b61ad5bf76","contentHash":"0008085f8e178332a14439b8e9cf70e25cb2bb9867f5212bccf1bebb8ed30448"},"C:\\dev\\quicksend-server\\src\\control\\device_manager.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\device_manager.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":73}},"3":{"start":{"line":5,"column":28},"end":{"line":5,"column":83}},"4":{"start":{"line":6,"column":18},"end":{"line":6,"column":63}},"5":{"start":{"line":9,"column":8},"end":{"line":9,"column":32}},"6":{"start":{"line":12,"column":8},"end":{"line":15,"column":11}},"7":{"start":{"line":13,"column":29},"end":{"line":13,"column":75}},"8":{"start":{"line":14,"column":12},"end":{"line":14,"column":30}},"9":{"start":{"line":18,"column":8},"end":{"line":21,"column":11}},"10":{"start":{"line":19,"column":29},"end":{"line":19,"column":78}},"11":{"start":{"line":20,"column":12},"end":{"line":20,"column":30}},"12":{"start":{"line":24,"column":8},"end":{"line":28,"column":11}},"13":{"start":{"line":25,"column":25},"end":{"line":25,"column":69}},"14":{"start":{"line":26,"column":25},"end":{"line":26,"column":76}},"15":{"start":{"line":27,"column":12},"end":{"line":27,"column":54}},"16":{"start":{"line":31,"column":8},"end":{"line":38,"column":11}},"17":{"start":{"line":32,"column":25},"end":{"line":36,"column":23}},"18":{"start":{"line":37,"column":12},"end":{"line":37,"column":71}},"19":{"start":{"line":41,"column":8},"end":{"line":41,"column":63}},"20":{"start":{"line":44,"column":22},"end":{"line":44,"column":41}},"21":{"start":{"line":45,"column":0},"end":{"line":45,"column":32}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":8,"column":4},"end":{"line":8,"column":5}},"loc":{"start":{"line":8,"column":18},"end":{"line":10,"column":5}},"line":8},"1":{"name":"(anonymous_1)","decl":{"start":{"line":11,"column":4},"end":{"line":11,"column":5}},"loc":{"start":{"line":11,"column":34},"end":{"line":16,"column":5}},"line":11},"2":{"name":"(anonymous_2)","decl":{"start":{"line":12,"column":55},"end":{"line":12,"column":56}},"loc":{"start":{"line":12,"column":68},"end":{"line":15,"column":9}},"line":12},"3":{"name":"(anonymous_3)","decl":{"start":{"line":17,"column":4},"end":{"line":17,"column":5}},"loc":{"start":{"line":17,"column":30},"end":{"line":22,"column":5}},"line":17},"4":{"name":"(anonymous_4)","decl":{"start":{"line":18,"column":55},"end":{"line":18,"column":56}},"loc":{"start":{"line":18,"column":68},"end":{"line":21,"column":9}},"line":18},"5":{"name":"(anonymous_5)","decl":{"start":{"line":23,"column":4},"end":{"line":23,"column":5}},"loc":{"start":{"line":23,"column":15},"end":{"line":29,"column":5}},"line":23},"6":{"name":"(anonymous_6)","decl":{"start":{"line":24,"column":55},"end":{"line":24,"column":56}},"loc":{"start":{"line":24,"column":68},"end":{"line":28,"column":9}},"line":24},"7":{"name":"(anonymous_7)","decl":{"start":{"line":30,"column":4},"end":{"line":30,"column":5}},"loc":{"start":{"line":30,"column":61},"end":{"line":39,"column":5}},"line":30},"8":{"name":"(anonymous_8)","decl":{"start":{"line":31,"column":55},"end":{"line":31,"column":56}},"loc":{"start":{"line":31,"column":68},"end":{"line":38,"column":9}},"line":31},"9":{"name":"(anonymous_9)","decl":{"start":{"line":40,"column":4},"end":{"line":40,"column":5}},"loc":{"start":{"line":40,"column":37},"end":{"line":42,"column":5}},"line":40}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":4,"7":4,"8":4,"9":5,"10":5,"11":5,"12":3,"13":3,"14":3,"15":3,"16":12,"17":12,"18":12,"19":53,"20":1,"21":1},"f":{"0":1,"1":4,"2":4,"3":5,"4":5,"5":3,"6":3,"7":12,"8":12,"9":53},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\device_manager.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\device_manager.ts"],"names":[],"mappings":";;;AAAA,0EAA+C;AAE/C,oFAAmD;AACnD,gEAAgC;AAGhC,MAAM,aAAc,SAAQ,iBAAiC;IAC5D;QACC,KAAK,CAAC,gBAAW,CAAC,CAAC;IACpB,CAAC;IAEK,iBAAiB,CAAC,IAAY,EAAE,IAAQ;;YAC7C,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;YAChE,OAAO,CAAC,CAAC,QAAQ,CAAC;QACnB,CAAC;KAAA;IAEK,eAAe,CAAC,EAAM,EAAE,IAAQ;;YACrC,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,GAAG,EAAE,EAAE,EAAE,IAAI,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;YACnE,OAAO,CAAC,CAAC,QAAQ,CAAC;QACnB,CAAC;KAAA;IAEK,IAAI,CAAC,IAAQ;;YAClB,MAAM,IAAI,GAAG,4CAA4C,CAAC;YAC1D,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,CAAC;YACjE,OAAO,IAAI,CAAC,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;QAC3C,CAAC;KAAA;IAEK,kBAAkB,CACvB,UAAc,EACd,UAAc,EACd,YAAgB;;YAEhB,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE;iBAClC,EAAE,CAAC,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,EAAE,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC;iBAChD,KAAK,CAAC,EAAE,GAAG,EAAE,EAAE,GAAG,EAAE,YAAY,EAAE,EAAE,CAAC;iBACrC,MAAM,CAAC,qBAAqB,CAAC;iBAC7B,IAAI,EAAE,CAAC;YACT,OAAO,IAAI,CAAC,iBAAiB,CAAC,IAAI,EAAE,qBAAqB,CAAC,CAAC;QAC5D,CAAC;KAAA;IAES,gBAAgB,CACzB,QAAqB,EACrB,IAAa;QAEb,OAAO,IAAI,2BAAgB,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IAC7C,CAAC;CACD;AAED,MAAM,aAAa,GAAG,IAAI,aAAa,EAAE,CAAC;AAE1C,kBAAe,aAAa,CAAC","sourcesContent":["import DeviceModel from \"src/db/models/device\";\nimport { Device } from \"src/db/schemas/device\";\nimport DeviceController from \"./device_controller\";\nimport Manager from \"./manager\";\nimport { Doc, ID } from \"./types\";\n\nclass DeviceManager extends Manager<Device, DeviceController> {\n\tconstructor() {\n\t\tsuper(DeviceModel);\n\t}\n\n\tasync nameExistsForUser(name: string, user: ID): Promise<boolean> {\n\t\tconst queryRes = await this.Model.exists({ name, user }).exec();\n\t\treturn !!queryRes;\n\t}\n\n\tasync idExistsForUser(id: ID, user: ID): Promise<boolean> {\n\t\tconst queryRes = await this.Model.exists({ _id: id, user }).exec();\n\t\treturn !!queryRes;\n\t}\n\n\tasync list(user: ID): Promise<DeviceController[]> {\n\t\tconst proj = \"name type lastActivity createdAt updatedAt\";\n\t\tconst docs = await this.Model.find({ user }).select(proj).exec();\n\t\treturn this.createControllers(docs, proj);\n\t}\n\n\tasync findMessageTargets(\n\t\ttargetUser: ID,\n\t\tsenderUser: ID,\n\t\tsenderDevice: ID\n\t): Promise<DeviceController[]> {\n\t\tconst docs = await this.Model.find()\n\t\t\t.or([{ user: targetUser }, { user: senderUser }])\n\t\t\t.where({ _id: { $ne: senderDevice } })\n\t\t\t.select(\"encryptionPublicKey\")\n\t\t\t.exec();\n\t\treturn this.createControllers(docs, \"encryptionPublicKey\");\n\t}\n\n\tprotected createController(\n\t\tdocument: Doc<Device>,\n\t\tproj?: string\n\t): DeviceController {\n\t\treturn new DeviceController(document, proj);\n\t}\n}\n\nconst deviceManager = new DeviceManager();\n\nexport default deviceManager;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"d9c8ad3143fafebdfea2acab54587839882542f4","contentHash":"e86d7c68f73551892b9de8e4a20e40e40fa06f78d228c9dd08a22c7427355683"},"C:\\dev\\quicksend-server\\src\\control\\device_controller.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\device_controller.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":21},"end":{"line":4,"column":69}},"3":{"start":{"line":7,"column":8},"end":{"line":7,"column":30}},"4":{"start":{"line":10,"column":0},"end":{"line":10,"column":35}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":6,"column":4},"end":{"line":6,"column":5}},"loc":{"start":{"line":6,"column":32},"end":{"line":8,"column":5}},"line":6}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":53,"4":1},"f":{"0":53},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\device_controller.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\device_controller.ts"],"names":[],"mappings":";;;AACA,sEAAsC;AAGtC,MAAM,gBAAiB,SAAQ,oBAAkB;IAChD,YAAY,QAAqB,EAAE,IAAa;QAC/C,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IACvB,CAAC;CACD;AAED,kBAAe,gBAAgB,CAAC","sourcesContent":["import { Device } from \"src/db/schemas/device\";\nimport Controller from \"./controller\";\nimport { Doc } from \"./types\";\n\nclass DeviceController extends Controller<Device> {\n\tconstructor(document: Doc<Device>, proj?: string) {\n\t\tsuper(document, proj);\n\t}\n}\n\nexport default DeviceController;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"7f03a32d0bb93c8261f44a0f0a7ab82b08532a85","contentHash":"51d84c3a94aa12ecd33a3f57dae2d541ea24cda7409dbd6566ed1062ae86ad39"},"C:\\dev\\quicksend-server\\src\\control\\utils.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\utils.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":0},"end":{"line":3,"column":27}},"2":{"start":{"line":4,"column":16},"end":{"line":4,"column":32}},"3":{"start":{"line":5,"column":19},"end":{"line":5,"column":63}},"4":{"start":{"line":7,"column":4},"end":{"line":7,"column":57}},"5":{"start":{"line":9,"column":0},"end":{"line":9,"column":30}}},"fnMap":{"0":{"name":"isValidID","decl":{"start":{"line":6,"column":9},"end":{"line":6,"column":18}},"loc":{"start":{"line":6,"column":23},"end":{"line":8,"column":1}},"line":6}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":50,"5":1},"f":{"0":50},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\utils.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\utils.ts"],"names":[],"mappings":";;;;AAAA,gEAAgC;AAGhC,SAAS,SAAS,CAAC,EAAM;IACxB,OAAO,kBAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;AAC5C,CAAC;AAEQ,8BAAS","sourcesContent":["import mongoose from \"mongoose\";\r\nimport { ID } from \"./types\";\r\n\r\nfunction isValidID(id: ID) {\r\n\treturn mongoose.Types.ObjectId.isValid(id);\r\n}\r\n\r\nexport { isValidID };\r\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"2d2e6a7e859f90ec1f6a8dfa223a60edaaea5a7b","contentHash":"5b6dd8974a6bc7e0867f27a432b2a60d003886e4cdd0cfcec9f364a39061eff8"},"C:\\dev\\quicksend-server\\src\\api\\devices.ts":{"path":"C:\\dev\\quicksend-server\\src\\api\\devices.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":64}},"3":{"start":{"line":5,"column":14},"end":{"line":5,"column":53}},"4":{"start":{"line":6,"column":18},"end":{"line":6,"column":70}},"5":{"start":{"line":7,"column":25},"end":{"line":7,"column":79}},"6":{"start":{"line":8,"column":25},"end":{"line":8,"column":87}},"7":{"start":{"line":9,"column":16},"end":{"line":9,"column":44}},"8":{"start":{"line":10,"column":16},"end":{"line":10,"column":60}},"9":{"start":{"line":11,"column":24},"end":{"line":16,"column":2}},"10":{"start":{"line":17,"column":0},"end":{"line":32,"column":4}},"11":{"start":{"line":17,"column":117},"end":{"line":32,"column":2}},"12":{"start":{"line":18,"column":17},"end":{"line":18,"column":33}},"13":{"start":{"line":19,"column":21},"end":{"line":19,"column":35}},"14":{"start":{"line":20,"column":4},"end":{"line":21,"column":70}},"15":{"start":{"line":21,"column":8},"end":{"line":21,"column":70}},"16":{"start":{"line":22,"column":22},"end":{"line":28,"column":6}},"17":{"start":{"line":29,"column":4},"end":{"line":29,"column":21}},"18":{"start":{"line":30,"column":4},"end":{"line":30,"column":36}},"19":{"start":{"line":31,"column":4},"end":{"line":31,"column":18}},"20":{"start":{"line":33,"column":27},"end":{"line":35,"column":2}},"21":{"start":{"line":36,"column":0},"end":{"line":45,"column":4}},"22":{"start":{"line":36,"column":116},"end":{"line":45,"column":2}},"23":{"start":{"line":37,"column":17},"end":{"line":37,"column":33}},"24":{"start":{"line":38,"column":21},"end":{"line":38,"column":35}},"25":{"start":{"line":39,"column":4},"end":{"line":40,"column":55}},"26":{"start":{"line":40,"column":8},"end":{"line":40,"column":55}},"27":{"start":{"line":41,"column":4},"end":{"line":42,"column":55}},"28":{"start":{"line":42,"column":8},"end":{"line":42,"column":55}},"29":{"start":{"line":43,"column":4},"end":{"line":43,"column":51}},"30":{"start":{"line":44,"column":4},"end":{"line":44,"column":18}},"31":{"start":{"line":46,"column":0},"end":{"line":58,"column":4}},"32":{"start":{"line":46,"column":62},"end":{"line":58,"column":2}},"33":{"start":{"line":47,"column":21},"end":{"line":47,"column":35}},"34":{"start":{"line":48,"column":23},"end":{"line":48,"column":71}},"35":{"start":{"line":49,"column":4},"end":{"line":56,"column":8}},"36":{"start":{"line":49,"column":46},"end":{"line":56,"column":5}},"37":{"start":{"line":57,"column":4},"end":{"line":57,"column":18}},"38":{"start":{"line":59,"column":0},"end":{"line":59,"column":26}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":17,"column":102},"end":{"line":17,"column":103}},"loc":{"start":{"line":17,"column":117},"end":{"line":32,"column":2}},"line":17},"1":{"name":"(anonymous_1)","decl":{"start":{"line":17,"column":159},"end":{"line":17,"column":160}},"loc":{"start":{"line":17,"column":172},"end":{"line":32,"column":1}},"line":17},"2":{"name":"(anonymous_2)","decl":{"start":{"line":36,"column":101},"end":{"line":36,"column":102}},"loc":{"start":{"line":36,"column":116},"end":{"line":45,"column":2}},"line":36},"3":{"name":"(anonymous_3)","decl":{"start":{"line":36,"column":158},"end":{"line":36,"column":159}},"loc":{"start":{"line":36,"column":171},"end":{"line":45,"column":1}},"line":36},"4":{"name":"(anonymous_4)","decl":{"start":{"line":46,"column":47},"end":{"line":46,"column":48}},"loc":{"start":{"line":46,"column":62},"end":{"line":58,"column":2}},"line":46},"5":{"name":"(anonymous_5)","decl":{"start":{"line":46,"column":104},"end":{"line":46,"column":105}},"loc":{"start":{"line":46,"column":117},"end":{"line":58,"column":1}},"line":46},"6":{"name":"(anonymous_6)","decl":{"start":{"line":49,"column":30},"end":{"line":49,"column":31}},"loc":{"start":{"line":49,"column":46},"end":{"line":56,"column":5}},"line":49}},"branchMap":{"0":{"loc":{"start":{"line":20,"column":4},"end":{"line":21,"column":70}},"type":"if","locations":[{"start":{"line":20,"column":4},"end":{"line":21,"column":70}},{"start":{"line":20,"column":4},"end":{"line":21,"column":70}}],"line":20},"1":{"loc":{"start":{"line":39,"column":4},"end":{"line":40,"column":55}},"type":"if","locations":[{"start":{"line":39,"column":4},"end":{"line":40,"column":55}},{"start":{"line":39,"column":4},"end":{"line":40,"column":55}}],"line":39},"2":{"loc":{"start":{"line":41,"column":4},"end":{"line":42,"column":55}},"type":"if","locations":[{"start":{"line":41,"column":4},"end":{"line":42,"column":55}},{"start":{"line":41,"column":4},"end":{"line":42,"column":55}}],"line":41}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":4,"12":4,"13":4,"14":4,"15":1,"16":3,"17":3,"18":3,"19":3,"20":1,"21":1,"22":5,"23":5,"24":5,"25":5,"26":0,"27":5,"28":3,"29":2,"30":2,"31":1,"32":3,"33":3,"34":3,"35":3,"36":4,"37":3,"38":1},"f":{"0":4,"1":4,"2":5,"3":5,"4":3,"5":3,"6":4},"b":{"0":[1,3],"1":[0,5],"2":[3,2]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\api\\devices.ts","sources":["C:\\dev\\quicksend-server\\src\\api\\devices.ts"],"names":[],"mappings":"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","sourcesContent":["import Router from \"@koa/router\";\nimport Joi from \"joi\";\nimport authHandler, { UserData } from \"src/auth/handler\";\nimport bodyValidator from \"src/body_validator\";\nimport deviceManager from \"src/control/device_manager\";\nimport { isValidID } from \"src/control/utils\";\n\nconst devices = new Router({ prefix: \"/devices\" });\n\ninterface AddDeviceRequest {\n\tname: string;\n\t/**\n\t * @see Device\n\t */\n\ttype?: number;\n\tsignaturePublicKey: string;\n\tencryptionPublicKey: string;\n}\n\nconst addDeviceSchema = Joi.object<AddDeviceRequest>({\n\tname: Joi.string().min(3).max(30).required(),\n\ttype: Joi.number().min(0),\n\tsignaturePublicKey: Joi.string().required(),\n\tencryptionPublicKey: Joi.string().required()\n});\n\ndevices.post(\n\t\"/add\",\n\tauthHandler(\"Basic\"),\n\tbodyValidator(addDeviceSchema),\n\tasync (ctx, next) => {\n\t\tconst body = ctx.request.body as AddDeviceRequest;\n\n\t\tconst userData = ctx.state.user as UserData;\n\n\t\tif (await deviceManager.nameExistsForUser(body.name, userData.id))\n\t\t\treturn ctx.throw(400, \"Device with this name already exists\");\n\t\tconst deviceCtr = await deviceManager.create({\n\t\t\tname: body.name,\n\t\t\ttype: body.type,\n\t\t\tuser: userData.id,\n\t\t\tsignaturePublicKey: body.signaturePublicKey,\n\t\t\tencryptionPublicKey: body.encryptionPublicKey\n\t\t});\n\t\tctx.status = 201;\n\t\tctx.body = { id: deviceCtr.id };\n\t\treturn next();\n\t}\n);\n\ninterface RemoveDeviceRequest {\n\tid: string;\n}\n\nconst removeDeviceSchema = Joi.object<RemoveDeviceRequest>({\n\tid: Joi.string().required()\n});\n\ndevices.post(\n\t\"/remove\",\n\tauthHandler(),\n\tbodyValidator(removeDeviceSchema),\n\tasync (ctx, next) => {\n\t\tconst body = ctx.request.body as RemoveDeviceRequest;\n\t\tconst userData = ctx.state.user as UserData;\n\n\t\tif (!isValidID(body.id)) return ctx.throw(400, \"Not a valid device id\");\n\t\tif (!(await deviceManager.idExistsForUser(body.id, userData.id)))\n\t\t\treturn ctx.throw(400, \"Device does not exist\");\n\t\tawait deviceManager.remove(body.id);\n\n\t\treturn next();\n\t}\n);\n\ndevices.get(\"/list\", authHandler(), async (ctx, next) => {\n\tconst userData = ctx.state.user as UserData;\n\n\tconst deviceCtrs = await deviceManager.list(userData.id);\n\n\tctx.body = deviceCtrs.map((deviceCtr) => ({\n\t\tid: deviceCtr.id.toHexString(),\n\t\tname: deviceCtr.get(\"name\"),\n\t\ttype: deviceCtr.get(\"type\"),\n\t\tlastActivity: deviceCtr.get(\"lastActivity\").toISOString(),\n\t\tcreatedAt: deviceCtr.get(\"createdAt\").toISOString(),\n\t\tupdatedAt: deviceCtr.get(\"updatedAt\").toISOString()\n\t}));\n\treturn next();\n});\n\nexport default devices;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"3e53c99cbb048d96c09ec63b5abd5e941ab7ad68","contentHash":"306f20632b49249edf22fadbd2ee01d67e5f9206b3f9102d5255500901edce46"},"C:\\dev\\quicksend-server\\src\\api\\messages.ts":{"path":"C:\\dev\\quicksend-server\\src\\api\\messages.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":64}},"3":{"start":{"line":5,"column":14},"end":{"line":5,"column":53}},"4":{"start":{"line":6,"column":18},"end":{"line":6,"column":70}},"5":{"start":{"line":7,"column":25},"end":{"line":7,"column":79}},"6":{"start":{"line":8,"column":25},"end":{"line":8,"column":87}},"7":{"start":{"line":9,"column":26},"end":{"line":9,"column":89}},"8":{"start":{"line":10,"column":23},"end":{"line":10,"column":83}},"9":{"start":{"line":11,"column":16},"end":{"line":11,"column":44}},"10":{"start":{"line":12,"column":16},"end":{"line":12,"column":36}},"11":{"start":{"line":13,"column":17},"end":{"line":13,"column":62}},"12":{"start":{"line":14,"column":0},"end":{"line":14,"column":50}},"13":{"start":{"line":15,"column":0},"end":{"line":25,"column":4}},"14":{"start":{"line":15,"column":48},"end":{"line":25,"column":2}},"15":{"start":{"line":16,"column":19},"end":{"line":16,"column":36}},"16":{"start":{"line":17,"column":4},"end":{"line":18,"column":49}},"17":{"start":{"line":18,"column":8},"end":{"line":18,"column":49}},"18":{"start":{"line":19,"column":4},"end":{"line":20,"column":53}},"19":{"start":{"line":20,"column":8},"end":{"line":20,"column":53}},"20":{"start":{"line":21,"column":23},"end":{"line":21,"column":117}},"21":{"start":{"line":22,"column":16},"end":{"line":22,"column":83}},"22":{"start":{"line":22,"column":46},"end":{"line":22,"column":82}},"23":{"start":{"line":23,"column":4},"end":{"line":23,"column":19}},"24":{"start":{"line":24,"column":4},"end":{"line":24,"column":18}},"25":{"start":{"line":26,"column":26},"end":{"line":31,"column":2}},"26":{"start":{"line":32,"column":26},"end":{"line":32,"column":32}},"27":{"start":{"line":33,"column":0},"end":{"line":64,"column":4}},"28":{"start":{"line":33,"column":88},"end":{"line":64,"column":2}},"29":{"start":{"line":34,"column":21},"end":{"line":34,"column":35}},"30":{"start":{"line":35,"column":44},"end":{"line":36,"column":13}},"31":{"start":{"line":37,"column":4},"end":{"line":38,"column":59}},"32":{"start":{"line":38,"column":8},"end":{"line":38,"column":59}},"33":{"start":{"line":39,"column":4},"end":{"line":40,"column":53}},"34":{"start":{"line":40,"column":8},"end":{"line":40,"column":53}},"35":{"start":{"line":41,"column":23},"end":{"line":41,"column":39}},"36":{"start":{"line":42,"column":23},"end":{"line":42,"column":56}},"37":{"start":{"line":43,"column":4},"end":{"line":44,"column":70}},"38":{"start":{"line":44,"column":8},"end":{"line":44,"column":70}},"39":{"start":{"line":45,"column":4},"end":{"line":46,"column":49}},"40":{"start":{"line":46,"column":8},"end":{"line":46,"column":49}},"41":{"start":{"line":47,"column":20},"end":{"line":47,"column":104}},"42":{"start":{"line":48,"column":22},"end":{"line":48,"column":70}},"43":{"start":{"line":48,"column":46},"end":{"line":48,"column":69}},"44":{"start":{"line":49,"column":19},"end":{"line":49,"column":73}},"45":{"start":{"line":50,"column":4},"end":{"line":51,"column":67}},"46":{"start":{"line":51,"column":8},"end":{"line":51,"column":67}},"47":{"start":{"line":52,"column":4},"end":{"line":53,"column":62}},"48":{"start":{"line":53,"column":8},"end":{"line":53,"column":62}},"49":{"start":{"line":54,"column":4},"end":{"line":61,"column":9}},"50":{"start":{"line":54,"column":97},"end":{"line":61,"column":5}},"51":{"start":{"line":62,"column":4},"end":{"line":62,"column":21}},"52":{"start":{"line":63,"column":4},"end":{"line":63,"column":18}},"53":{"start":{"line":65,"column":0},"end":{"line":75,"column":4}},"54":{"start":{"line":65,"column":37},"end":{"line":75,"column":2}},"55":{"start":{"line":66,"column":21},"end":{"line":66,"column":37}},"56":{"start":{"line":67,"column":24},"end":{"line":67,"column":70}},"57":{"start":{"line":68,"column":4},"end":{"line":73,"column":8}},"58":{"start":{"line":68,"column":48},"end":{"line":73,"column":5}},"59":{"start":{"line":74,"column":4},"end":{"line":74,"column":18}},"60":{"start":{"line":76,"column":0},"end":{"line":76,"column":27}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":15,"column":33},"end":{"line":15,"column":34}},"loc":{"start":{"line":15,"column":48},"end":{"line":25,"column":2}},"line":15},"1":{"name":"(anonymous_1)","decl":{"start":{"line":15,"column":90},"end":{"line":15,"column":91}},"loc":{"start":{"line":15,"column":103},"end":{"line":25,"column":1}},"line":15},"2":{"name":"(anonymous_2)","decl":{"start":{"line":22,"column":31},"end":{"line":22,"column":32}},"loc":{"start":{"line":22,"column":46},"end":{"line":22,"column":82}},"line":22},"3":{"name":"(anonymous_3)","decl":{"start":{"line":33,"column":73},"end":{"line":33,"column":74}},"loc":{"start":{"line":33,"column":88},"end":{"line":64,"column":2}},"line":33},"4":{"name":"(anonymous_4)","decl":{"start":{"line":33,"column":130},"end":{"line":33,"column":131}},"loc":{"start":{"line":33,"column":143},"end":{"line":64,"column":1}},"line":33},"5":{"name":"(anonymous_5)","decl":{"start":{"line":48,"column":34},"end":{"line":48,"column":35}},"loc":{"start":{"line":48,"column":46},"end":{"line":48,"column":69}},"line":48},"6":{"name":"(anonymous_6)","decl":{"start":{"line":54,"column":74},"end":{"line":54,"column":75}},"loc":{"start":{"line":54,"column":97},"end":{"line":61,"column":5}},"line":54},"7":{"name":"(anonymous_7)","decl":{"start":{"line":65,"column":22},"end":{"line":65,"column":23}},"loc":{"start":{"line":65,"column":37},"end":{"line":75,"column":2}},"line":65},"8":{"name":"(anonymous_8)","decl":{"start":{"line":65,"column":79},"end":{"line":65,"column":80}},"loc":{"start":{"line":65,"column":92},"end":{"line":75,"column":1}},"line":65},"9":{"name":"(anonymous_9)","decl":{"start":{"line":68,"column":31},"end":{"line":68,"column":32}},"loc":{"start":{"line":68,"column":48},"end":{"line":73,"column":5}},"line":68}},"branchMap":{"0":{"loc":{"start":{"line":17,"column":4},"end":{"line":18,"column":49}},"type":"if","locations":[{"start":{"line":17,"column":4},"end":{"line":18,"column":49}},{"start":{"line":17,"column":4},"end":{"line":18,"column":49}}],"line":17},"1":{"loc":{"start":{"line":19,"column":4},"end":{"line":20,"column":53}},"type":"if","locations":[{"start":{"line":19,"column":4},"end":{"line":20,"column":53}},{"start":{"line":19,"column":4},"end":{"line":20,"column":53}}],"line":19},"2":{"loc":{"start":{"line":37,"column":4},"end":{"line":38,"column":59}},"type":"if","locations":[{"start":{"line":37,"column":4},"end":{"line":38,"column":59}},{"start":{"line":37,"column":4},"end":{"line":38,"column":59}}],"line":37},"3":{"loc":{"start":{"line":39,"column":4},"end":{"line":40,"column":53}},"type":"if","locations":[{"start":{"line":39,"column":4},"end":{"line":40,"column":53}},{"start":{"line":39,"column":4},"end":{"line":40,"column":53}}],"line":39},"4":{"loc":{"start":{"line":43,"column":4},"end":{"line":44,"column":70}},"type":"if","locations":[{"start":{"line":43,"column":4},"end":{"line":44,"column":70}},{"start":{"line":43,"column":4},"end":{"line":44,"column":70}}],"line":43},"5":{"loc":{"start":{"line":45,"column":4},"end":{"line":46,"column":49}},"type":"if","locations":[{"start":{"line":45,"column":4},"end":{"line":46,"column":49}},{"start":{"line":45,"column":4},"end":{"line":46,"column":49}}],"line":45},"6":{"loc":{"start":{"line":50,"column":4},"end":{"line":51,"column":67}},"type":"if","locations":[{"start":{"line":50,"column":4},"end":{"line":51,"column":67}},{"start":{"line":50,"column":4},"end":{"line":51,"column":67}}],"line":50},"7":{"loc":{"start":{"line":52,"column":4},"end":{"line":53,"column":62}},"type":"if","locations":[{"start":{"line":52,"column":4},"end":{"line":53,"column":62}},{"start":{"line":52,"column":4},"end":{"line":53,"column":62}}],"line":52}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":1,"13":1,"14":6,"15":6,"16":6,"17":1,"18":5,"19":0,"20":5,"21":5,"22":7,"23":5,"24":5,"25":1,"26":1,"27":1,"28":9,"29":9,"30":9,"31":9,"32":1,"33":8,"34":1,"35":7,"36":7,"37":7,"38":0,"39":7,"40":0,"41":7,"42":7,"43":9,"44":7,"45":7,"46":2,"47":5,"48":1,"49":4,"50":5,"51":4,"52":4,"53":1,"54":0,"55":0,"56":0,"57":0,"58":0,"59":0,"60":1},"f":{"0":6,"1":6,"2":7,"3":9,"4":9,"5":9,"6":5,"7":0,"8":0,"9":0},"b":{"0":[1,5],"1":[0,5],"2":[1,8],"3":[1,7],"4":[0,7],"5":[0,7],"6":[2,5],"7":[1,4]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\api\\messages.ts","sources":["C:\\dev\\quicksend-server\\src\\api\\messages.ts"],"names":[],"mappings":"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","sourcesContent":["import Router from \"@koa/router\";\nimport Joi from \"joi\";\nimport authHandler, { UserData } from \"src/auth/handler\";\nimport bodyValidator from \"src/body_validator\";\nimport deviceManager from \"src/control/device_manager\";\nimport messageManager from \"src/control/message_manager\";\nimport { ID } from \"src/control/types\";\nimport userManager from \"src/control/user_manager\";\nimport { isValidID } from \"src/control/utils\";\nimport { arrayDiff } from \"src/utils\";\n\nconst messages = new Router({ prefix: \"/messages\" });\nmessages.use(authHandler(\"Signature\"));\n\nmessages.get(\"/targets/:userId\", async (ctx, next) => {\n\tconst userId = ctx.params.userId;\n\tif (!isValidID(userId)) return ctx.throw(400, \"Invalid user id\");\n\n\tif (!(await userManager.idExists(userId)))\n\t\treturn ctx.throw(400, \"User does not exist\");\n\tconst deviceCtrs = await deviceManager.findMessageTargets(\n\t\tuserId,\n\t\tctx.state.user.id,\n\t\tctx.state.device\n\t);\n\n\tconst ids: string[] = deviceCtrs.map((deviceCtr) =>\n\t\tdeviceCtr.get(\"encryptionPublicKey\")\n\t);\n\tctx.body = ids;\n\n\treturn next();\n});\n\ninterface SendMessageRequest {\n\tto: string;\n\tsentAt: string;\n\theaders: Record<string, string>;\n\tbodies: Record<string, string>;\n}\n\nconst sendMessageSchema = Joi.object<SendMessageRequest>({\n\tto: Joi.string().required(),\n\tsentAt: Joi.string().isoDate().required(),\n\theaders: Joi.object().pattern(Joi.string(), Joi.string()).optional(),\n\tbodies: Joi.object().pattern(Joi.string(), Joi.string()).required()\n});\n\nconst MESSAGE_AGE_LIMIT = 300000; // 5 minutes\n\nmessages.post(\"/send\", bodyValidator(sendMessageSchema), async (ctx, next) => {\n\tconst userData = ctx.state.user as UserData;\n\tconst { to, sentAt, headers, bodies } = ctx.request\n\t\t.body as SendMessageRequest;\n\tif (!isValidID(to)) return ctx.throw(400, \"Invalid recipient user id\");\n\tif (!(await userManager.idExists(to)))\n\t\treturn ctx.throw(400, \"User does not exist\");\n\n\tconst sentAtDate = new Date(sentAt);\n\tconst messageAge = Date.now() - sentAtDate.getTime();\n\tif (messageAge < 0)\n\t\treturn ctx.throw(400, \"Cannot send messages from the future\");\n\tif (messageAge > MESSAGE_AGE_LIMIT) return ctx.throw(400, \"Message too old\");\n\n\tconst targets = await deviceManager.findMessageTargets(\n\t\tto,\n\t\tuserData.id,\n\t\tctx.state.device\n\t);\n\tconst targetIds = targets.map((device) => device.id.toHexString());\n\n\tconst idDiff = arrayDiff(Object.keys(bodies), targetIds);\n\tif (idDiff.missing.length > 0)\n\t\treturn ctx.throw(400, \"Missing required target device(s)\");\n\tif (idDiff.extra.length > 0)\n\t\treturn ctx.throw(400, \"Extraneous unknown device(s)\");\n\n\tawait messageManager.createMany(\n\t\tObject.entries(bodies).map(([deviceId, body]) => ({\n\t\t\tfromUser: userData.id,\n\t\t\ttoUser: to,\n\t\t\ttoDevice: deviceId,\n\t\t\tsentAt: new Date(sentAt),\n\t\t\theaders,\n\t\t\tbody\n\t\t}))\n\t);\n\n\tctx.status = 201;\n\treturn next();\n});\n\nmessages.get(\"/poll\", async (ctx, next) => {\n\tconst deviceId = ctx.state.device as ID;\n\tconst messageCtrs = await messageManager.poll(deviceId);\n\tctx.body = messageCtrs.map((messageCtr) => ({\n\t\tfromUser: messageCtr.get(\"fromUser\"),\n\t\tsentAt: messageCtr.get(\"sentAt\"),\n\t\theaders: messageCtr.get(\"headers\"),\n\t\tbody: messageCtr.get(\"body\")\n\t}));\n\n\treturn next();\n});\n\nexport default messages;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"e382018ca956bbeb33a15233255c0eae2ea5d00b","contentHash":"dc6424afe98ea4740b16918d1fa4390f4c56ce977ba48092fa4d7009a1aef05a"},"C:\\dev\\quicksend-server\\src\\control\\message_manager.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\message_manager.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":18},"end":{"line":4,"column":75}},"3":{"start":{"line":5,"column":18},"end":{"line":5,"column":63}},"4":{"start":{"line":6,"column":29},"end":{"line":6,"column":85}},"5":{"start":{"line":9,"column":8},"end":{"line":9,"column":33}},"6":{"start":{"line":12,"column":8},"end":{"line":12,"column":64}},"7":{"start":{"line":15,"column":8},"end":{"line":20,"column":11}},"8":{"start":{"line":16,"column":31},"end":{"line":18,"column":23}},"9":{"start":{"line":19,"column":12},"end":{"line":19,"column":54}},"10":{"start":{"line":23,"column":8},"end":{"line":25,"column":11}},"11":{"start":{"line":24,"column":12},"end":{"line":24,"column":64}},"12":{"start":{"line":28,"column":23},"end":{"line":28,"column":43}},"13":{"start":{"line":29,"column":0},"end":{"line":29,"column":33}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":8,"column":4},"end":{"line":8,"column":5}},"loc":{"start":{"line":8,"column":18},"end":{"line":10,"column":5}},"line":8},"1":{"name":"(anonymous_1)","decl":{"start":{"line":11,"column":4},"end":{"line":11,"column":5}},"loc":{"start":{"line":11,"column":37},"end":{"line":13,"column":5}},"line":11},"2":{"name":"(anonymous_2)","decl":{"start":{"line":14,"column":4},"end":{"line":14,"column":5}},"loc":{"start":{"line":14,"column":19},"end":{"line":21,"column":5}},"line":14},"3":{"name":"(anonymous_3)","decl":{"start":{"line":15,"column":55},"end":{"line":15,"column":56}},"loc":{"start":{"line":15,"column":68},"end":{"line":20,"column":9}},"line":15},"4":{"name":"(anonymous_4)","decl":{"start":{"line":22,"column":4},"end":{"line":22,"column":5}},"loc":{"start":{"line":22,"column":20},"end":{"line":26,"column":5}},"line":22},"5":{"name":"(anonymous_5)","decl":{"start":{"line":23,"column":55},"end":{"line":23,"column":56}},"loc":{"start":{"line":23,"column":68},"end":{"line":25,"column":9}},"line":23}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":5,"7":0,"8":0,"9":0,"10":0,"11":0,"12":1,"13":1},"f":{"0":1,"1":5,"2":0,"3":0,"4":0,"5":0},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\message_manager.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\message_manager.ts"],"names":[],"mappings":";;;AAAA,4EAAiD;AAEjD,gEAAgC;AAChC,sFAAqD;AAGrD,MAAM,cAAe,SAAQ,iBAAmC;IAC/D;QACC,KAAK,CAAC,iBAAY,CAAC,CAAC;IACrB,CAAC;IAES,gBAAgB,CACzB,QAAsB,EACtB,IAAa;QAEb,OAAO,IAAI,4BAAiB,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IAC9C,CAAC;IAEK,IAAI,CAAC,QAAY;;YACtB,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC;iBAC9D,MAAM,CAAC,8BAA8B,CAAC;iBACtC,IAAI,EAAE,CAAC;YACT,OAAO,IAAI,CAAC,iBAAiB,CAAC,UAAU,CAAC,CAAC;QAC3C,CAAC;KAAA;IAEK,KAAK,CAAC,QAAY;;YACvB,MAAM,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC,CAAC;QACrD,CAAC;KAAA;CACD;AACD,MAAM,cAAc,GAAG,IAAI,cAAc,EAAE,CAAC;AAE5C,kBAAe,cAAc,CAAC","sourcesContent":["import MessageModel from \"src/db/models/message\";\nimport { Message } from \"src/db/schemas/message\";\nimport Manager from \"./manager\";\nimport MessageController from \"./message_controller\";\nimport { Doc, ID } from \"./types\";\n\nclass MessageManager extends Manager<Message, MessageController> {\n\tconstructor() {\n\t\tsuper(MessageModel);\n\t}\n\n\tprotected createController(\n\t\tdocument: Doc<Message>,\n\t\tproj?: string\n\t): MessageController {\n\t\treturn new MessageController(document, proj);\n\t}\n\n\tasync poll(deviceId: ID): Promise<MessageController[]> {\n\t\tconst deviceDocs = await this.Model.find({ toDevice: deviceId })\n\t\t\t.select(\"fromUser sentAt headers body\")\n\t\t\t.exec();\n\t\treturn this.createControllers(deviceDocs);\n\t}\n\n\tasync clear(deviceId: ID): Promise<void> {\n\t\tawait this.Model.deleteMany({ toDevice: deviceId });\n\t}\n}\nconst messageManager = new MessageManager();\n\nexport default messageManager;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"108e04a651213aca679ccf6b72a6599c473508ed","contentHash":"15dfce368af42be7f13b7b2f200aa6a0df2d4a78c37f7f85ef0b090b5ce87daf"},"C:\\dev\\quicksend-server\\src\\db\\models\\message.ts":{"path":"C:\\dev\\quicksend-server\\src\\db\\models\\message.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":19},"end":{"line":4,"column":63}},"3":{"start":{"line":5,"column":18},"end":{"line":5,"column":76}},"4":{"start":{"line":6,"column":21},"end":{"line":6,"column":75}},"5":{"start":{"line":7,"column":0},"end":{"line":7,"column":31}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\db\\models\\message.ts","sources":["C:\\dev\\quicksend-server\\src\\db\\models\\message.ts"],"names":[],"mappings":";;;AAAA,gEAAgC;AAChC,6EAAmD;AAEnD,MAAM,YAAY,GAAG,kBAAQ,CAAC,KAAK,CAAC,SAAS,EAAE,iBAAa,CAAC,CAAC;AAE9D,kBAAe,YAAY,CAAC","sourcesContent":["import mongoose from \"mongoose\";\nimport MessageSchema from \"src/db/schemas/message\";\n\nconst MessageModel = mongoose.model(\"message\", MessageSchema);\n\nexport default MessageModel;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"abca6888aaedd07fe1c26026927b293ac5be2dad","contentHash":"ac92ac091e78292ee96ca6de9d0eefa851f7739ddf168547871a8d82f2812cda"},"C:\\dev\\quicksend-server\\src\\db\\schemas\\message.ts":{"path":"C:\\dev\\quicksend-server\\src\\db\\schemas\\message.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":19},"end":{"line":4,"column":63}},"3":{"start":{"line":5,"column":17},"end":{"line":5,"column":73}},"4":{"start":{"line":6,"column":15},"end":{"line":6,"column":65}},"5":{"start":{"line":7,"column":22},"end":{"line":29,"column":2}},"6":{"start":{"line":30,"column":0},"end":{"line":30,"column":32}}},"fnMap":{},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1},"f":{},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\db\\schemas\\message.ts","sources":["C:\\dev\\quicksend-server\\src\\db\\schemas\\message.ts"],"names":[],"mappings":";;;AAAA,gEAAgC;AAChC,0EAA+C;AAC/C,kEAAuC;AAYvC,MAAM,aAAa,GAAG,IAAI,kBAAQ,CAAC,MAAM,CAAU;IAClD,QAAQ,EAAE;QACT,IAAI,EAAE,kBAAQ,CAAC,WAAW,CAAC,QAAQ;QACnC,QAAQ,EAAE,IAAI;QACd,GAAG,EAAE,cAAS;KACd;IACD,MAAM,EAAE;QACP,IAAI,EAAE,kBAAQ,CAAC,WAAW,CAAC,QAAQ;QACnC,QAAQ,EAAE,IAAI;KACd;IACD,QAAQ,EAAE;QACT,IAAI,EAAE,kBAAQ,CAAC,WAAW,CAAC,QAAQ;QACnC,QAAQ,EAAE,IAAI;QACd,GAAG,EAAE,gBAAW;KAChB;IACD,MAAM,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE;IACtC,OAAO,EAAE;QACR,IAAI,EAAE,kBAAQ,CAAC,WAAW,CAAC,GAAG;QAC9B,EAAE,EAAE,MAAM;QACV,OAAO,EAAE,IAAI,GAAG,EAAkB;KAClC;IACD,IAAI,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE;CACtC,CAAC,CAAC;AAEH,kBAAe,aAAa,CAAC","sourcesContent":["import mongoose from \"mongoose\";\nimport DeviceModel from \"src/db/models/device\";\nimport UserModel from \"../models/user\";\nimport { DBObject } from \"./base\";\n\ninterface Message extends DBObject {\n\tfromUser: mongoose.Types.ObjectId;\n\ttoUser: mongoose.Types.ObjectId;\n\ttoDevice: mongoose.Types.ObjectId;\n\tsentAt: Date;\n\theaders: mongoose.Types.Map<string>;\n\tbody: string;\n}\n\nconst MessageSchema = new mongoose.Schema<Message>({\n\tfromUser: {\n\t\ttype: mongoose.SchemaTypes.ObjectId,\n\t\trequired: true,\n\t\tref: UserModel\n\t},\n\ttoUser: {\n\t\ttype: mongoose.SchemaTypes.ObjectId,\n\t\trequired: true\n\t},\n\ttoDevice: {\n\t\ttype: mongoose.SchemaTypes.ObjectId,\n\t\trequired: true,\n\t\tref: DeviceModel\n\t},\n\tsentAt: { type: Date, required: true },\n\theaders: {\n\t\ttype: mongoose.SchemaTypes.Map,\n\t\tof: String,\n\t\tdefault: new Map<string, string>()\n\t},\n\tbody: { type: String, required: true }\n});\n\nexport default MessageSchema;\nexport type { Message };\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"1bd15d9a83414422afd06aadcb222c4b2ec294f1","contentHash":"a0087e0c8ce3f38c9d224b818574b1c61ba012421031bd51e9f6f1d6b1eb1af5"},"C:\\dev\\quicksend-server\\src\\control\\message_controller.ts":{"path":"C:\\dev\\quicksend-server\\src\\control\\message_controller.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":21},"end":{"line":4,"column":69}},"3":{"start":{"line":7,"column":8},"end":{"line":7,"column":30}},"4":{"start":{"line":10,"column":0},"end":{"line":10,"column":36}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":6,"column":4},"end":{"line":6,"column":5}},"loc":{"start":{"line":6,"column":32},"end":{"line":8,"column":5}},"line":6}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":5,"4":1},"f":{"0":5},"b":{},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\control\\message_controller.ts","sources":["C:\\dev\\quicksend-server\\src\\control\\message_controller.ts"],"names":[],"mappings":";;;AACA,sEAAsC;AAGtC,MAAM,iBAAkB,SAAQ,oBAAmB;IAClD,YAAY,QAAsB,EAAE,IAAa;QAChD,KAAK,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IACvB,CAAC;CACD;AAED,kBAAe,iBAAiB,CAAC","sourcesContent":["import { Message } from \"src/db/schemas/message\";\nimport Controller from \"./controller\";\nimport { Doc } from \"./types\";\n\nclass MessageController extends Controller<Message> {\n\tconstructor(document: Doc<Message>, proj?: string) {\n\t\tsuper(document, proj);\n\t}\n}\n\nexport default MessageController;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"eac2fbd2c7e77cc0af3ea79a2621b35ae007d5f0","contentHash":"627798ed78173d684276a0e374cd1acc9725dea3154e8b39fa21c2fa3ca057e5"},"C:\\dev\\quicksend-server\\src\\response.ts":{"path":"C:\\dev\\quicksend-server\\src\\response.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":20},"end":{"line":6,"column":1}},"3":{"start":{"line":5,"column":19},"end":{"line":5,"column":38}},"4":{"start":{"line":8,"column":25},"end":{"line":8,"column":42}},"5":{"start":{"line":9,"column":4},"end":{"line":10,"column":20}},"6":{"start":{"line":10,"column":8},"end":{"line":10,"column":20}},"7":{"start":{"line":11,"column":28},"end":{"line":11,"column":51}},"8":{"start":{"line":12,"column":4},"end":{"line":12,"column":39}},"9":{"start":{"line":13,"column":4},"end":{"line":14,"column":20}},"10":{"start":{"line":14,"column":8},"end":{"line":14,"column":20}},"11":{"start":{"line":15,"column":18},"end":{"line":15,"column":55}},"12":{"start":{"line":16,"column":4},"end":{"line":23,"column":5}},"13":{"start":{"line":17,"column":24},"end":{"line":17,"column":32}},"14":{"start":{"line":18,"column":8},"end":{"line":22,"column":9}},"15":{"start":{"line":19,"column":12},"end":{"line":19,"column":29}},"16":{"start":{"line":20,"column":12},"end":{"line":20,"column":48}},"17":{"start":{"line":21,"column":12},"end":{"line":21,"column":25}},"18":{"start":{"line":24,"column":4},"end":{"line":24,"column":16}},"19":{"start":{"line":27,"column":19},"end":{"line":27,"column":59}},"20":{"start":{"line":28,"column":4},"end":{"line":32,"column":5}},"21":{"start":{"line":29,"column":8},"end":{"line":29,"column":25}},"22":{"start":{"line":30,"column":8},"end":{"line":30,"column":53}},"23":{"start":{"line":31,"column":8},"end":{"line":31,"column":20}},"24":{"start":{"line":33,"column":4},"end":{"line":33,"column":18}},"25":{"start":{"line":36,"column":17},"end":{"line":36,"column":21}},"26":{"start":{"line":37,"column":4},"end":{"line":40,"column":36}},"27":{"start":{"line":38,"column":8},"end":{"line":38,"column":45}},"28":{"start":{"line":40,"column":8},"end":{"line":40,"column":36}},"29":{"start":{"line":41,"column":4},"end":{"line":41,"column":22}},"30":{"start":{"line":42,"column":4},"end":{"line":42,"column":43}},"31":{"start":{"line":45,"column":4},"end":{"line":53,"column":7}},"32":{"start":{"line":45,"column":26},"end":{"line":53,"column":6}},"33":{"start":{"line":46,"column":8},"end":{"line":47,"column":19}},"34":{"start":{"line":47,"column":12},"end":{"line":47,"column":19}},"35":{"start":{"line":48,"column":23},"end":{"line":48,"column":37}},"36":{"start":{"line":49,"column":8},"end":{"line":50,"column":19}},"37":{"start":{"line":50,"column":12},"end":{"line":50,"column":19}},"38":{"start":{"line":51,"column":8},"end":{"line":51,"column":21}},"39":{"start":{"line":52,"column":8},"end":{"line":52,"column":39}},"40":{"start":{"line":55,"column":0},"end":{"line":55,"column":34}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":5,"column":10},"end":{"line":5,"column":11}},"loc":{"start":{"line":5,"column":19},"end":{"line":5,"column":38}},"line":5},"1":{"name":"handleCharset","decl":{"start":{"line":7,"column":9},"end":{"line":7,"column":22}},"loc":{"start":{"line":7,"column":28},"end":{"line":25,"column":1}},"line":7},"2":{"name":"getFormat","decl":{"start":{"line":26,"column":9},"end":{"line":26,"column":18}},"loc":{"start":{"line":26,"column":24},"end":{"line":34,"column":1}},"line":26},"3":{"name":"serializeResponse","decl":{"start":{"line":35,"column":9},"end":{"line":35,"column":26}},"loc":{"start":{"line":35,"column":40},"end":{"line":43,"column":1}},"line":35},"4":{"name":"responseHandler","decl":{"start":{"line":44,"column":9},"end":{"line":44,"column":24}},"loc":{"start":{"line":44,"column":27},"end":{"line":54,"column":1}},"line":44},"5":{"name":"(anonymous_5)","decl":{"start":{"line":45,"column":11},"end":{"line":45,"column":12}},"loc":{"start":{"line":45,"column":26},"end":{"line":53,"column":6}},"line":45},"6":{"name":"(anonymous_6)","decl":{"start":{"line":45,"column":66},"end":{"line":45,"column":67}},"loc":{"start":{"line":45,"column":79},"end":{"line":53,"column":5}},"line":45}},"branchMap":{"0":{"loc":{"start":{"line":9,"column":4},"end":{"line":10,"column":20}},"type":"if","locations":[{"start":{"line":9,"column":4},"end":{"line":10,"column":20}},{"start":{"line":9,"column":4},"end":{"line":10,"column":20}}],"line":9},"1":{"loc":{"start":{"line":13,"column":4},"end":{"line":14,"column":20}},"type":"if","locations":[{"start":{"line":13,"column":4},"end":{"line":14,"column":20}},{"start":{"line":13,"column":4},"end":{"line":14,"column":20}}],"line":13},"2":{"loc":{"start":{"line":16,"column":4},"end":{"line":23,"column":5}},"type":"if","locations":[{"start":{"line":16,"column":4},"end":{"line":23,"column":5}},{"start":{"line":16,"column":4},"end":{"line":23,"column":5}}],"line":16},"3":{"loc":{"start":{"line":18,"column":8},"end":{"line":22,"column":9}},"type":"if","locations":[{"start":{"line":18,"column":8},"end":{"line":22,"column":9}},{"start":{"line":18,"column":8},"end":{"line":22,"column":9}}],"line":18},"4":{"loc":{"start":{"line":28,"column":4},"end":{"line":32,"column":5}},"type":"if","locations":[{"start":{"line":28,"column":4},"end":{"line":32,"column":5}},{"start":{"line":28,"column":4},"end":{"line":32,"column":5}}],"line":28},"5":{"loc":{"start":{"line":37,"column":4},"end":{"line":40,"column":36}},"type":"if","locations":[{"start":{"line":37,"column":4},"end":{"line":40,"column":36}},{"start":{"line":37,"column":4},"end":{"line":40,"column":36}}],"line":37},"6":{"loc":{"start":{"line":46,"column":8},"end":{"line":47,"column":19}},"type":"if","locations":[{"start":{"line":46,"column":8},"end":{"line":47,"column":19}},{"start":{"line":46,"column":8},"end":{"line":47,"column":19}}],"line":46},"7":{"loc":{"start":{"line":49,"column":8},"end":{"line":50,"column":19}},"type":"if","locations":[{"start":{"line":49,"column":8},"end":{"line":50,"column":19}},{"start":{"line":49,"column":8},"end":{"line":50,"column":19}}],"line":49}},"s":{"0":1,"1":1,"2":1,"3":46,"4":46,"5":46,"6":46,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":46,"20":46,"21":0,"22":0,"23":0,"24":46,"25":46,"26":46,"27":26,"28":20,"29":46,"30":46,"31":1,"32":46,"33":46,"34":0,"35":46,"36":46,"37":0,"38":46,"39":46,"40":1},"f":{"0":46,"1":46,"2":46,"3":46,"4":1,"5":46,"6":46},"b":{"0":[46,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,46],"5":[26,20],"6":[0,46],"7":[0,46]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\response.ts","sources":["C:\\dev\\quicksend-server\\src\\response.ts"],"names":[],"mappings":";;;AAGA,MAAM,WAAW,GAA6C;IAC7D,IAAI,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC;CAClC,CAAC;AAEF,SAAS,aAAa,CAAC,GAAgB;IACtC,MAAM,YAAY,GAAG,GAAG,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IACvC,IAAI,CAAC,YAAY;QAAE,OAAO,IAAI,CAAC;IAC/B,MAAM,CAAC,MAAM,EAAE,KAAK,CAAC,GAAG,YAAY,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IAChD,GAAG,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,GAAG,MAAM,CAAC;IACnC,IAAI,CAAC,KAAK;QAAE,OAAO,IAAI,CAAC;IACxB,MAAM,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC;IACpD,IAAI,KAAK,EAAE;QACV,MAAM,OAAO,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;QACzB,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE;YAC/B,GAAG,CAAC,MAAM,GAAG,GAAG,CAAC;YACjB,GAAG,CAAC,IAAI,GAAG,wBAAwB,CAAC;YACpC,OAAO,KAAK,CAAC;SACb;KACD;IACD,OAAO,IAAI,CAAC;AACb,CAAC;AAED,SAAS,SAAS,CAAC,GAAgB;IAClC,MAAM,MAAM,GAAG,GAAG,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;IACxD,IAAI,CAAC,MAAM,EAAE;QACZ,GAAG,CAAC,MAAM,GAAG,GAAG,CAAC;QACjB,GAAG,CAAC,IAAI,GAAG,iCAAiC,CAAC;QAC7C,OAAO,IAAI,CAAC;KACZ;IACD,OAAO,MAAM,CAAC;AACf,CAAC;AAED,SAAS,iBAAiB,CAAC,GAAgB,EAAE,MAAc;IAC1D,IAAI,MAAM,GAA0B,IAAI,CAAC;IACzC,IAAI,GAAG,CAAC,KAAK,CAAC,KAAK;QAAE,MAAM,GAAG,EAAE,KAAK,EAAE,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC;;QACrD,MAAM,GAAG,EAAE,IAAI,EAAE,GAAG,CAAC,IAAI,EAAE,CAAC;IACjC,GAAG,CAAC,IAAI,GAAG,MAAM,CAAC;IAClB,GAAG,CAAC,IAAI,GAAG,WAAW,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC,CAAC;AACxC,CAAC;AAED,SAAS,eAAe;IACvB,OAAO,CAAO,GAAG,EAAE,IAAI,EAAE,EAAE;QAC1B,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC;YAAE,OAAO;QAChC,MAAM,MAAM,GAAG,SAAS,CAAC,GAAG,CAAC,CAAC;QAC9B,IAAI,CAAC,MAAM;YAAE,OAAO;QAEpB,MAAM,IAAI,EAAE,CAAC;QAEb,iBAAiB,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;IAChC,CAAC,CAAA,CAAC;AACH,CAAC;AAED,kBAAe,eAAe,CAAC","sourcesContent":["import Koa from \"koa\";\ntype ResponseObject = { data: unknown } | { error: string };\n\nconst serializers: Record<string, (obj: unknown) => string> = {\n\tjson: (obj) => JSON.stringify(obj)\n};\n\nfunction handleCharset(ctx: Koa.Context): boolean {\n\tconst acceptHeader = ctx.get(\"Accept\");\n\tif (!acceptHeader) return true;\n\tconst [accept, param] = acceptHeader.split(\";\");\n\tctx.request.header.accept = accept;\n\tif (!param) return true;\n\tconst match = param.match(/charset=([a-z0-9_-]+)/i);\n\tif (match) {\n\t\tconst charset = match[1];\n\t\tif (!/^utf-?8$/i.test(charset)) {\n\t\t\tctx.status = 406;\n\t\t\tctx.body = \"Encoding not supported\";\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\nfunction getFormat(ctx: Koa.Context): string | null {\n\tconst format = ctx.accepts(...Object.keys(serializers));\n\tif (!format) {\n\t\tctx.status = 406;\n\t\tctx.body = \"No supported content type found\";\n\t\treturn null;\n\t}\n\treturn format;\n}\n\nfunction serializeResponse(ctx: Koa.Context, format: string) {\n\tlet resObj: ResponseObject | null = null;\n\tif (ctx.state.error) resObj = { error: String(ctx.body) };\n\telse resObj = { data: ctx.body };\n\tctx.type = format;\n\tctx.body = serializers[format](resObj);\n}\n\nfunction responseHandler(): Koa.Middleware {\n\treturn async (ctx, next) => {\n\t\tif (!handleCharset(ctx)) return;\n\t\tconst format = getFormat(ctx);\n\t\tif (!format) return;\n\n\t\tawait next();\n\n\t\tserializeResponse(ctx, format);\n\t};\n}\n\nexport default responseHandler;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"85f4d4176def7a64b8d289199d7d437bee24e92f","contentHash":"304fbc5ce5d40427d2653acb6f2cb15a75b7cff8c504fb4bca6c376896763a33"},"C:\\dev\\quicksend-server\\src\\compress.ts":{"path":"C:\\dev\\quicksend-server\\src\\compress.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":16},"end":{"line":3,"column":32}},"2":{"start":{"line":4,"column":15},"end":{"line":4,"column":55}},"3":{"start":{"line":6,"column":27},"end":{"line":6,"column":54}},"4":{"start":{"line":7,"column":4},"end":{"line":8,"column":15}},"5":{"start":{"line":8,"column":8},"end":{"line":8,"column":15}},"6":{"start":{"line":9,"column":22},"end":{"line":9,"column":65}},"7":{"start":{"line":10,"column":15},"end":{"line":10,"column":44}},"8":{"start":{"line":11,"column":4},"end":{"line":25,"column":5}},"9":{"start":{"line":12,"column":8},"end":{"line":24,"column":9}},"10":{"start":{"line":14,"column":16},"end":{"line":14,"column":55}},"11":{"start":{"line":15,"column":16},"end":{"line":15,"column":22}},"12":{"start":{"line":17,"column":16},"end":{"line":17,"column":56}},"13":{"start":{"line":18,"column":16},"end":{"line":18,"column":22}},"14":{"start":{"line":20,"column":16},"end":{"line":20,"column":65}},"15":{"start":{"line":21,"column":16},"end":{"line":21,"column":22}},"16":{"start":{"line":23,"column":16},"end":{"line":23,"column":70}},"17":{"start":{"line":26,"column":4},"end":{"line":26,"column":39}},"18":{"start":{"line":29,"column":21},"end":{"line":29,"column":47}},"19":{"start":{"line":30,"column":4},"end":{"line":31,"column":20}},"20":{"start":{"line":31,"column":8},"end":{"line":31,"column":20}},"21":{"start":{"line":32,"column":20},"end":{"line":32,"column":57}},"22":{"start":{"line":33,"column":4},"end":{"line":37,"column":5}},"23":{"start":{"line":34,"column":26},"end":{"line":34,"column":43}},"24":{"start":{"line":35,"column":8},"end":{"line":36,"column":24}},"25":{"start":{"line":36,"column":12},"end":{"line":36,"column":24}},"26":{"start":{"line":38,"column":4},"end":{"line":38,"column":17}},"27":{"start":{"line":41,"column":4},"end":{"line":42,"column":15}},"28":{"start":{"line":42,"column":8},"end":{"line":42,"column":15}},"29":{"start":{"line":43,"column":4},"end":{"line":44,"column":15}},"30":{"start":{"line":44,"column":8},"end":{"line":44,"column":15}},"31":{"start":{"line":46,"column":4},"end":{"line":51,"column":15}},"32":{"start":{"line":47,"column":8},"end":{"line":47,"column":24}},"33":{"start":{"line":48,"column":9},"end":{"line":51,"column":15}},"34":{"start":{"line":49,"column":8},"end":{"line":49,"column":37}},"35":{"start":{"line":51,"column":8},"end":{"line":51,"column":15}},"36":{"start":{"line":52,"column":4},"end":{"line":52,"column":45}},"37":{"start":{"line":53,"column":4},"end":{"line":53,"column":40}},"38":{"start":{"line":56,"column":4},"end":{"line":60,"column":7}},"39":{"start":{"line":56,"column":26},"end":{"line":60,"column":6}},"40":{"start":{"line":57,"column":8},"end":{"line":57,"column":32}},"41":{"start":{"line":58,"column":8},"end":{"line":58,"column":21}},"42":{"start":{"line":59,"column":8},"end":{"line":59,"column":30}},"43":{"start":{"line":62,"column":0},"end":{"line":62,"column":27}}},"fnMap":{"0":{"name":"decompressRequests","decl":{"start":{"line":5,"column":9},"end":{"line":5,"column":27}},"loc":{"start":{"line":5,"column":33},"end":{"line":27,"column":1}},"line":5},"1":{"name":"acceptsEncoding","decl":{"start":{"line":28,"column":9},"end":{"line":28,"column":24}},"loc":{"start":{"line":28,"column":40},"end":{"line":39,"column":1}},"line":28},"2":{"name":"compressResponse","decl":{"start":{"line":40,"column":9},"end":{"line":40,"column":25}},"loc":{"start":{"line":40,"column":31},"end":{"line":54,"column":1}},"line":40},"3":{"name":"compress","decl":{"start":{"line":55,"column":9},"end":{"line":55,"column":17}},"loc":{"start":{"line":55,"column":20},"end":{"line":61,"column":1}},"line":55},"4":{"name":"(anonymous_4)","decl":{"start":{"line":56,"column":11},"end":{"line":56,"column":12}},"loc":{"start":{"line":56,"column":26},"end":{"line":60,"column":6}},"line":56},"5":{"name":"(anonymous_5)","decl":{"start":{"line":56,"column":66},"end":{"line":56,"column":67}},"loc":{"start":{"line":56,"column":79},"end":{"line":60,"column":5}},"line":56}},"branchMap":{"0":{"loc":{"start":{"line":7,"column":4},"end":{"line":8,"column":15}},"type":"if","locations":[{"start":{"line":7,"column":4},"end":{"line":8,"column":15}},{"start":{"line":7,"column":4},"end":{"line":8,"column":15}}],"line":7},"1":{"loc":{"start":{"line":12,"column":8},"end":{"line":24,"column":9}},"type":"switch","locations":[{"start":{"line":13,"column":12},"end":{"line":15,"column":22}},{"start":{"line":16,"column":12},"end":{"line":18,"column":22}},{"start":{"line":19,"column":12},"end":{"line":21,"column":22}},{"start":{"line":22,"column":12},"end":{"line":23,"column":70}}],"line":12},"2":{"loc":{"start":{"line":30,"column":4},"end":{"line":31,"column":20}},"type":"if","locations":[{"start":{"line":30,"column":4},"end":{"line":31,"column":20}},{"start":{"line":30,"column":4},"end":{"line":31,"column":20}}],"line":30},"3":{"loc":{"start":{"line":35,"column":8},"end":{"line":36,"column":24}},"type":"if","locations":[{"start":{"line":35,"column":8},"end":{"line":36,"column":24}},{"start":{"line":35,"column":8},"end":{"line":36,"column":24}}],"line":35},"4":{"loc":{"start":{"line":35,"column":12},"end":{"line":35,"column":49}},"type":"binary-expr","locations":[{"start":{"line":35,"column":12},"end":{"line":35,"column":31}},{"start":{"line":35,"column":35},"end":{"line":35,"column":49}}],"line":35},"5":{"loc":{"start":{"line":41,"column":4},"end":{"line":42,"column":15}},"type":"if","locations":[{"start":{"line":41,"column":4},"end":{"line":42,"column":15}},{"start":{"line":41,"column":4},"end":{"line":42,"column":15}}],"line":41},"6":{"loc":{"start":{"line":43,"column":4},"end":{"line":44,"column":15}},"type":"if","locations":[{"start":{"line":43,"column":4},"end":{"line":44,"column":15}},{"start":{"line":43,"column":4},"end":{"line":44,"column":15}}],"line":43},"7":{"loc":{"start":{"line":46,"column":4},"end":{"line":51,"column":15}},"type":"if","locations":[{"start":{"line":46,"column":4},"end":{"line":51,"column":15}},{"start":{"line":46,"column":4},"end":{"line":51,"column":15}}],"line":46},"8":{"loc":{"start":{"line":48,"column":9},"end":{"line":51,"column":15}},"type":"if","locations":[{"start":{"line":48,"column":9},"end":{"line":51,"column":15}},{"start":{"line":48,"column":9},"end":{"line":51,"column":15}}],"line":48}},"s":{"0":1,"1":1,"2":1,"3":46,"4":46,"5":46,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":46,"28":46,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":1,"39":46,"40":46,"41":46,"42":46,"43":1},"f":{"0":46,"1":0,"2":46,"3":1,"4":46,"5":46},"b":{"0":[46,0],"1":[0,0,0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[46,0],"6":[0,0],"7":[0,0],"8":[0,0]},"inputSourceMap":{"version":3,"file":"C:\\dev\\quicksend-server\\src\\compress.ts","sources":["C:\\dev\\quicksend-server\\src\\compress.ts"],"names":[],"mappings":";;;AAAA,wDAAwB;AAGxB,SAAS,kBAAkB,CAAC,GAAgB;IAC3C,MAAM,cAAc,GAAG,GAAG,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;IACnD,IAAI,CAAC,cAAc;QAAE,OAAO;IAC5B,MAAM,SAAS,GAAG,cAAc,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IAC9D,IAAI,IAAI,GAAW,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;IACjD,KAAK,MAAM,QAAQ,IAAI,SAAS,EAAE;QACjC,QAAQ,QAAQ,EAAE;YACjB,KAAK,MAAM;gBACV,IAAI,GAAG,cAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;gBAC7B,MAAM;YACP,KAAK,SAAS;gBACb,IAAI,GAAG,cAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;gBAC9B,MAAM;YACP,KAAK,IAAI;gBACR,IAAI,GAAG,cAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAC;gBACvC,MAAM;YACP;gBACC,OAAO,GAAG,CAAC,KAAK,CAAC,GAAG,EAAE,8BAA8B,CAAC,CAAC;SACvD;KACD;IACD,GAAG,CAAC,OAAO,CAAC,IAAI,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;AACpC,CAAC;AAED,SAAS,eAAe,CAAC,GAAgB,EAAE,QAAgB;IAC1D,MAAM,QAAQ,GAAG,GAAG,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC;IAC5C,IAAI,CAAC,QAAQ;QAAE,OAAO,IAAI,CAAC;IAC3B,MAAM,OAAO,GAAG,QAAQ,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IACtD,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE;QAC7B,MAAM,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACpC,IAAI,OAAO,IAAI,QAAQ,IAAI,OAAO,IAAI,GAAG;YAAE,OAAO,IAAI,CAAC;KACvD;IACD,OAAO,KAAK,CAAC;AACd,CAAC;AAED,SAAS,gBAAgB,CAAC,GAAgB;IACzC,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,QAAQ;QAAE,OAAO;IAChC,IAAI,CAAC,eAAe,CAAC,GAAG,EAAE,MAAM,CAAC;QAAE,OAAO;IAE1C,IAAI,IAAY,CAAC;IACjB,IAAI,GAAG,CAAC,IAAI,YAAY,MAAM;QAAE,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC;SAC3C,IAAI,OAAO,GAAG,CAAC,IAAI,IAAI,QAAQ;QAAE,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;;QAC9D,OAAO;IAEZ,GAAG,CAAC,IAAI,GAAG,cAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;IAC/B,GAAG,CAAC,GAAG,CAAC,kBAAkB,EAAE,MAAM,CAAC,CAAC;AACrC,CAAC;AAED,SAAS,QAAQ;IAChB,OAAO,CAAO,GAAG,EAAE,IAAI,EAAE,EAAE;QAC1B,kBAAkB,CAAC,GAAG,CAAC,CAAC;QACxB,MAAM,IAAI,EAAE,CAAC;QACb,gBAAgB,CAAC,GAAG,CAAC,CAAC;IACvB,CAAC,CAAA,CAAC;AACH,CAAC;AAED,kBAAe,QAAQ,CAAC","sourcesContent":["import zlib from \"zlib\";\nimport Koa from \"koa\";\n\nfunction decompressRequests(ctx: Koa.Context) {\n\tconst encodingHeader = ctx.get(\"Content-Encoding\");\n\tif (!encodingHeader) return;\n\tconst encodings = encodingHeader.replace(/ /g, \"\").split(\",\");\n\tlet body: Buffer = Buffer.from(ctx.request.body);\n\tfor (const encoding of encodings) {\n\t\tswitch (encoding) {\n\t\t\tcase \"gzip\":\n\t\t\t\tbody = zlib.gunzipSync(body);\n\t\t\t\tbreak;\n\t\t\tcase \"deflate\":\n\t\t\t\tbody = zlib.inflateSync(body);\n\t\t\t\tbreak;\n\t\t\tcase \"br\":\n\t\t\t\tbody = zlib.brotliDecompressSync(body);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn ctx.throw(400, \"Unsupported content encoding\");\n\t\t}\n\t}\n\tctx.request.body = body.toString();\n}\n\nfunction acceptsEncoding(ctx: Koa.Context, encoding: string): boolean {\n\tconst aeHeader = ctx.get(\"Accept-Encoding\");\n\tif (!aeHeader) return true;\n\tconst options = aeHeader.replace(/ /g, \"\").split(\",\");\n\tfor (const option of options) {\n\t\tconst [encName] = option.split(\";\");\n\t\tif (encName == encoding || encName == \"*\") return true;\n\t}\n\treturn false;\n}\n\nfunction compressResponse(ctx: Koa.Context) {\n\tif (!ctx.state.compress) return;\n\tif (!acceptsEncoding(ctx, \"gzip\")) return;\n\n\tlet body: Buffer;\n\tif (ctx.body instanceof Buffer) body = ctx.body;\n\telse if (typeof ctx.body == \"string\") body = Buffer.from(ctx.body);\n\telse return;\n\n\tctx.body = zlib.gzipSync(body);\n\tctx.set(\"Content-Encoding\", \"gzip\");\n}\n\nfunction compress(): Koa.Middleware {\n\treturn async (ctx, next) => {\n\t\tdecompressRequests(ctx);\n\t\tawait next();\n\t\tcompressResponse(ctx);\n\t};\n}\n\nexport default compress;\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"bf43f72f8b08062f701ea804ccd5392c5b00926b","contentHash":"72385330b94a09279778c090fc686f5c3a9f53c667b9e610c6dcfa93f991c379"}}